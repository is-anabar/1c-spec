## Билет 15 (занятия 100-102)


Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно только в одном подразделении компании, то есть совместительство не допускается.
Сотрудники компании работают в 3 смены по графику сутки через двое.

Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в часах. Часовая ставка рассчитывается как начальное значение оклада, деленное на количество рабочих часов в том же периоде, что и фактически отработанные часы. Первоначальное значение оклада может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода. В информационной базе необходимо хранить историю его изменения.

Сотрудники могут находиться на больничном, размер которого определяется как количество дней болезни, умноженное на среднюю дневную ставку. Дни болезни рассчитываются по пятидневному графику. Средняя дневная ставка определяется как сумма всех начислений за предыдущий месяц, поделенная на количество рабочих дней в предыдущем месяце. Следует учесть, что данные об отпуске не могут вводиться в систему задним числом.

В любой момент времени каждому из сотрудников может быть начислено поощрение в виде произвольной суммы денег.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисления зарплаты». Документ в расчетном периоде может быть только один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление оклада с 10.01 по 31.01, а запись оклад: с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

С помощью диаграммы Ганта показать фактический период действия записей с разбивкой по сотрудникам, и для каждого сотрудника – по видам расчета. Отчет может быть построен за любой расчетный период.



### Подразделения

Совместительства нет, поэтому убираем подразделения там, где они есть.


### Графики работы
Создаем справочник `ГрафикиРаботы`. Добавляем предопределенные элементы `Пятидневка` (обязательно), `Смена 1, Смена 2, Смена 3` (необязательно) .


### Регистр сведений **Графики работы**

- добавляем измерение **График работы**
- переименовываем `Значение` в `Часов`, добавляем `Дней`


### Обработка **Заполнение графика**

- добавляем флажок `ЭтоСменныйГрафик`;
- при заполнении учитываем флажок:
	- если сменный, то выходные считаются в зависимости от номера текущего дня; количество часов - 24;
	- если по пятидневке, то выходные считаются от номера дня недели


### План видов расчета **Основные начисления**

- на вкладе **Расчеты** ставим:
	- `Использует период действия` - да
	- `Зависит по периоду действия` - основные и дополнительные начисления
- добавляем `Больничный`. На вкладке `Базовые` выбираем все виды расчета (+ добавится `Произвольная сумма денег`)
- для `Оклад` на вкладке `Вытесняющие` выбираем "Больничный"


### План видов расчета **Дополнительные начисления**

- убираем все флаги с вкладки `Расчеты` убираем
- добавляем `Произвольная сумма денег`; не забываем ее выставить базой для `Больничный`


### Регистр расчета **Основные начисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - да
- стандартные измерение `Сотрудник` и ресурс `Результат`
- добавляем реквизиты:
	- `ГрафикРаботы, ЧасовФакт, ЧасовПлан, Оклад` (для оклада)
		- если при подсчете `ЧасовФакт и ЧасовПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `График работы` с измерением регистра `Графики работы`
	- `ДнейФакт, ДнейПлан, ОсноваДляНачислений` (для больничного)


### Регистр расчета **Дополнительные начисления**

- стандартные измерение `Сотрудник` и ресурс `Результат`


### Документ **Начисление зарплаты**

Общий алгоритм расчета аналогичен [билету 9](/СПР/спр%20билет%209.md), отличается только расчет начислений в хронологическом порядке.

- `Оперативное проведение` - **Запретить**
- в ТЧ `ОсновныеНачисления` добавляем поле `ГрафикРаботы`
- добавляем ТЧ для дополнительных начислений 

1. Записываем все движения (в т.ч. сторно)
Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим
- для записей, введенных задним числом, добавляем движения с помощью таблицы дополнений.
```
ТаблицаДополнений = Движения.ОсновныеНачисления.ПолучитьДополнение();
```
При создании движений переносим в движение основные реквизиты - `Сотрудник, ГрафикРаботы, ВидРасчета, Оклад`. `Оклад` понадобится для сторнирования зарплаты (если брать актуальный, то там может выйти намного больше или намного меньше, чем нужно сторнировать).
- для ТЧ дополнительных начислений заполняем **базовый период** (для каждой строки - прошлый месяц) + меняем насильно график на `Пятидневка`

2. Последовательное заполнение данных
Чтобы при расчете больничного учитывались предыдущие больничные в том числе, необходимо производить расчет в хронологическом порядке, т.к. по возрастанию `ПериодДействия`.

Нужно получить все уникальные для документа периоды действия, после чего:
- получаем данные по зп для текущего периода действия, рассчитываем (первыми посчитаются сторно, потом - актуальные записи)
- получаем данные для расчета больничного - зп + дополнительные начисления за текущий период действия, рассчитываем


### Отчет **Диаграмма Ганта**

- создаем отчет + произвольную форму
- добавляем `Диаграмма Ганта, Период` +  кнопка `Сформировать`
- с помощью запроса получаем данные `ФактическийПериодДействия` с отбором по `ПериодДействия`
- в коде формируем диаграмму:
```1c
// обязательно очищаем, иначе будет неверное отображение
ДиаграммаГанта.Обновление = Ложь;
ДиаграммаГанта.Очистить();

// ...
	
Пока Выборка.Следующий() Цикл
	Точка = ДиаграммаГанта.УстановитьТочку(Выборка.Сотрудник); 
	Точка.Текст = Выборка.Сотрудник;
		
	Серия = ДиаграммаГанта.УстановитьСерию(Выборка.ВидРасчета);
	Серия.Текст = Выборка.ВидРасчета;
		
	ЗначениеДГ = ДиаграммаГанта.ПолучитьЗначение(Точка, Серия);
		
	Интервал = ЗначениеДГ.Добавить();
	Интервал.Начало = Выборка.ПериодДействияНачало;
	Интервал.Конец = Выборка.ПериодДействияКонец;
КонецЦикла; 
```
