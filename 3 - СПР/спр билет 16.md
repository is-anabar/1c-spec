# Билет 16 (занятия 90, 91 - c 32:00 по 53:30)

Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается.

Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам.

Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в часах. Часовая ставка рассчитывается как начальное значение оклада, деленное на количество рабочих часов в том же периоде, что и фактически отработанные часы. Первоначальное значение оклада определяется пользователем самостоятельно и заносится в документ «Начисление зарплаты».

За каждый отработанный день в течение периода начисления сотрудникам предприятия полагается фиксированная сумма денег в качестве компенсации затрат на разговоры по мобильному телефону. Данная ставка едина для всех сотрудников компании и должна быть зафиксирована в информационной базе.

Создать отчет «Перерасчет зарплаты», в котором пользователь должен иметь возможность увидеть записи регистра расчета, которые возможно требуется пересчитать. В отчете должна быть возможность выполнить процедуру перерасчета записей.

|Объект перерасчета	|Вид расчета |… |
|---|---|---|



## Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ ОсновныеНачисления + ДополнительныеНачисления), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления` и `ДополнительныеНачисления`


## ГрафикиРаботы

Создаем справочник ГрафикиРаботы


## Регистр сведений ГрафикиРаботы

- Измерения:
	- Дата
	- График работы
- Ресурсы:
	- Часов (для оклада)
	- Дней (для расчета компенсации)


## Обработка ЗаполнениеГрафика

- дополнительно заполняем **ГрафикРаботы** и **Дней**


## Создаем константу БазоваяСтавкаКомпенсации



## Планы видов расчета

### Основные начисления

- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - да
	- `Зависит по периоду действия` - нет

### Дополнительные начисления

- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - нет
	- `Зависит по периоду действия` - ОсновныеНачисления (для получения основы для расчета компенсации)
- Добавляем **Компенсация**
	- На вкладке `Базовые` выбираем Оклад



## Регистры расчета

### Основные начисления

- Вкладка `Расчеты`
	- Период действия - да; заполняем поля
	- Базовый период - нет
- Измерения:
	- Сотрудник (базовое)
	- Подразделение (базовое)
- Ресурсы:
	- Результат
	- ДнейФакт (для расчета отработанных дней для компенсации за мобильный)
- Реквизиты:
	- Оклад
	- Часов факт
	- Часов план


### Дополнительные начисления

- Вкладка `Расчеты`
	- Период действия - нет
	- Базовый период - да
- Измерения:
	- Сотрудник (базовое)
	- Подразделение (базовое)
- Ресурсы:
	- Результат
- Реквизиты:
	- Дней факт
	- Базовая ставка компенсации


### Перерасчеты

В `Дополнительные начисления` для вида `Оклад` выставляем:
- Ведущие: Оклад

Создаем перерасчет для `Дополнительных начислений`.

- Измерения
	- Сотрудник
	- Подразделение
- Измерения регистра: -//-
- Данные ведущих регистров: 
	- Сотрудник (из Основных начислений)
	- Подразделение (-//-)




## Документ НачислениеЗарплаты

- Оперативное проведение - Запретить
- Добавляем в ТЧ ОсновныеНачисления поле ГрафикРаботы
- Добавляем табличную часть для дополнительных начислений


### Примечание

Для создание отчета необходимо сделать некоторые предварительные действия:
- создаем общий модуль (флаги `сервер + внешнее соединение`)


### Записываем все движения

Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим.
- `Дополнительные начисления` переносим. Для вида расчета `Компенсация`:
	- заполняем **базовый период** (для каждой строки - текущий месяц)

### Расчет ЗП

Создаем в общем модуле экспортную процедуру `ЗаполнитьОсновныеНачисления(НаборЗаписей, Регистратор)` 
- в качестве НаборЗаписей будут передаваться `Движения.ОсновныеНачисления`
- в качестве Регистратор - `Ссылка`

Начисление ЗП - стандартное

### Расчет компенсации

Создаем в общем модуле экспортную процедуру `ЗаполнитьДополнительныеНачисления(НаборЗаписей, Регистратор, ТаблицаОтборов = Неопределено)`
- в качестве НаборЗаписей будут передаваться `Движения.Дополнительные`
- в качестве Регистратор - `Ссылка`
- в качестве ТаблицаОтборов - данные `Подразделение + Сотрудник`, которые нужно рассчитать (из документа всегда передается Неопределено; таблица будет 	заполняться в отчете)
	
Начисление компенсации:
- Определяем, мы сейчас перерасчитываем документ или нет: 
```1c
ЭтоПерерасчеты = (ТаблицаОтборов <> Неопределено);
```
- Выборка для дополнительных начислений стандартная, только нужно добавить отбор:
```1c	
Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДополнительныеНачисленияБазаОсновныеНачисления.НомерСтроки КАК НомерСтроки,
	|	ДополнительныеНачисленияБазаОсновныеНачисления.ДнейФактБаза КАК ДнейФакт
	|ИЗ
	|	РегистрРасчета.ДополнительныеНачисления.БазаОсновныеНачисления(
	|			&Измерения,
	|			&Измерения,
	|			,
	|			Регистратор = &Ссылка
	|				И ВидРасчета В (&ВидыРасчета)
	|				И &ДополнительноеУсловие) КАК ДополнительныеНачисленияБазаОсновныеНачисления";

// исправляем условие, если это перерасчет	
Если ЭтоПерерасчеты Тогда
	ДополнительноеУсловие = "(Сотрудник, Подразделение) В (&ТаблицаОтборов)"
Иначе
	ДополнительноеУсловие = "ИСТИНА";
КонецЕсли;
Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ДополнительноеУсловие", ДополнительноеУсловие);
```
- Далее просто рассчитываем компенсацию


## Отчет

### Форма отчета

Создаем свою форму отчета:
- Добавляем в реквизиты формы `Результат` (табличный документ)
- Добавляем команду `Перерассчитать`:
	- выносим на форму
	- создаем процедуры на клиенте и сервере

### Получение `ТаблицаОтборов` для перерассчета компенсации

С помощью запроса получаем данные о документе, сотруднике, подразделении (итоги по документу), которые надо перерассчитать:
- Создаем таблицу отборов (шаблон)
```1c
ТаблицаОтборов = Новый ТаблицаЗначений; 
ТаблицаОтборов.Колонки.Добавить("Сотрудник", Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
ТаблицаОтборов.Колонки.Добавить("Подразделение", Новый ОписаниеТипов("СправочникСсылка.Подразделения"));
```
- Заполняем таблицу отборов
```1c
// Обходим все документы
Пока ВыборкаИтог.Следующий() Цикл
		
	// Обходим все записи в документах
	Выборка = ВыборкаИтог.Выбрать();
	ТаблицаОтборов.Очистить();
		
	// Заполняем данные для отбора
	Пока Выборка.Следующий() Цикл
		Строка = ТаблицаОтборов.Добавить();
		ЗаполнитьЗначенияСвойств(Строка, Выборка);
	КонецЦикла;
		
	// Создаем набор записей для перерасчета
	НаборЗаписей = РегистрыРасчета.ДополнительныеНачисления.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаИтог.ОбъектПерерасчета);
	НаборЗаписей.Прочитать();
		
	ПерерасчетыСервер.ЗаполнитьДополнительныеНачисления(НаборЗаписей, ВыборкаИтог.ОбъектПерерасчета, ТаблицаОтборов);
		
КонецЦикла;
```
- Для автоматического обновления отчета добавляем в конце
```1c
СкомпоноватьРезультат();
```

3. Отчет
С помощью СКД получаем информацию о перерасчетах