## Билет 12 (занятия 87-88, 89)

Начисление зарплаты сотрудникам автопредприятия осуществляется ежемесячно с использованием метода отклонений. Сотрудники работают на собственных автомобилях, поэтому обмен автомобилями между водителями не возможен.

Все сотрудники работают только по пятидневному графику.

Сотрудники предприятия получают оплату по часовому тарифу. Сумма начисления по тарифу определяется как тарифная ставка, умноженная на количество фактически отработанных часов. В течение расчетного периода тарифная ставка может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода. В информационной базе необходимо хранить историю ее изменения.

Если сотрудник не вышел на работу по неуважительной причине, то за каждый день прогула начисляется штраф в размере 5000 рублей. Следует учесть, что данные о невыходе не могут вводиться в систему задним числом.

Если водитель в расчетном периоде наездил больше 1000 часов, то ему должна быть начислена компенсация на ремонт автомобиля процентом от начисленной в том же расчетном периоде оплаты по тарифу. Процент компенсации общий для всех сотрудников и может изменяться не чаще, чем один раз в месяц. В информационной базе необходимо хранить историю изменения данного процента. В момент начисления компенсации значение процента определяется пользователем самостоятельно и заносится в документ Начисление зарплаты. Компенсация начисляется только в случае отсутствия невыходов, однако контролировать программным образом данное обстоятельство не требуется.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление по тарифу с 10.01 по 31.01, а запись тариф: с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

Для анализа полученных сотрудниками предприятия компенсаций на ремонт в конфигурации необходимо предусмотреть отчет следующего вида:

|Сотрудник	|Отработано часов   |Был штраф? |Сумма компенсации  |
|---		|---				|---		|---				|
|Итого:	|		





#### Подразделения

Совместительства нет, поэтому убираем подразделения там, где они есть.


### Регистр сведений ГрафикиРаботы
- Переименовать реквизит `Значение` в `Часов`
- Добавить ресурс `Дней` (для прогула) 


### Обработка ЗаполнениеГрафика
- заполняем Часов + Дней


### Регистр сведений ПроцентКомпенсации
- ресурс `ПроцентКомпенсации`


### Фиксация наезженных часов
Создаем:
- документ `Наезженные часы`
- регистр накопления (остаточный) для хранения наезженных часов
	- измерение `Сотрудник`
	- ресурс `Км`


### План видов расчета ОсновныеНачисления
- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - да
	- `Зависит по периоду действия` - ОсновныеНачисления и ДополнительныеНачисления (для получения основы для расчета компенсации)
- Добавляем Прогул
- Для Оклад на вкладке `Вытесняющие` выбираем Прогул 


### План видов расчета ДополнительныеНачисления
- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - нет
	- `Зависит по периоду действия` - ОсновныеНачисления (для получения основы для расчета компенсации)
- Добавляем Компенсация. 
	- На вкладке `Базовые` выбираем Оклад


### Регистр расчета ОсновныеНачисления
- На вкладке Основная выставляем: 
	- Период действия - да, заполняем поля
- Добавляем реквизиты `Оклад,  ЧасовФакт, ЧасовПлан` (оба - для оклада) и `ДнейФакт` (прогулы)


### Регистр расчета ДополнительныеНачисления
- На вкладке Основная выставляем:
	- Базовый период - да
- Добавляем реквизиты `ЧасовНаезжено, ОсноваДляНачисления и ПроцентКомпенсации`


### Документ НачислениеЗарплаты
- Оперативное проведение - Запретить
- Добавляем табличную часть для дополнительных начислений

1. Записываем все движения
	Пробегаем по всем ТЧ документа:
	- `Основные начисления` переносим.
	- `Дополнительные начисления` переносим. Для вида расчета `Компенсация`:
		- заполняем **базовый период** (для каждой строки - текущий месяц)


2. Расчет оклада + штраф
	Расчет ЗП почти стандартный:
	- получаем данные по `Сотрудник`, `ЧасовФакт +  ЧасовПлан` (для ЗП), `ДнейФакт` (прогулы)
	- соединяемся с данными по базовой ставке оклада

	После этого пробегаем выборку:
	- если строка - ЗП, то рассчитываем ЗП как обычно; переносим необходимые данные в движение
	- если строка - Штраф, то рассчитываем штраф (кол-во дней * базовый штраф, минусуем); переносим необходимые данные в движение


3. Начисление компенсации
	- получаем основу для начислений - `РезультатБаза`
	- соединяемся с данными по наезженным часам (на конец месяца)

	После этого пробегаем выборку:
	- Если больше 1000, то:
		- записываем компенсацию 
		- уменьшаем количество часов (расходное движение); записываем на начало следующего месяца


### Отчет
Запрос состоит из 2 частей:

1. Получаем информацию с отбором по периоду и виду расчета:
	- первый подзапрос - `оклад` (из `ДанныеГрафика` ): сотрудник, `ЧасовФактическийПериодДействия`, 0 (был штраф), 0 (сумма компенсации)
	- второй подзапрос - `штрафы` (из `ДанныеГрафика`): сотрудник, 0, `1`, 0
	- третий подзапрос - `компенсация` (из `ДополнительныеНачсиления`): сотрудник, 0, 0, `Результат`

	С помощью `ОБЪЕДИНИТЬ ВСЕ` собираем данные вместе

2. Группируем по сотруднику

Для окладов и компенсации - сумма
Для штрафа - максимум
