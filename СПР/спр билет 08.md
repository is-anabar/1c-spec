## Билет 8 (занятия 105 - 106)


Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений и ведется одновременно в двух валютах (долларах США и евро). В информационной базе нужно хранить историю изменений курса валют. При начислении зарплаты необходимо использовать курс валюты, актуальный на дату документа.

Сотрудники предприятия получают оплату по часовому тарифу. Сумма начисления по тарифу определяется как тарифная ставка, умноженная на количество фактически отработанных часов. Тарифная ставка должна быть определена отдельно для каждого подразделения по специальной шкале в зависимости от отработанного времени и вводится пользователем в режиме. 1С:Предприятие. Например:

|Подразделение      |Фактически отработанные часы   |Размер ставки  |
|-------------------|-------------------------------|---------------|
|Отдел внедрения 	|до 60          	            |12,5           |
|Отдел внедрения    |от 60 до 130	                |25             |
|Отдел внедрения    |от 130 	                    |35             |
|Бухгалтерия        |до 50	                        |10             |
|Бухгалтерия    	|от 50 до 150	                |20             |
|Бухгалтерия    	|от 150	                        |40             |

Сотрудники могут работать сверхурочно по плану, установленному заранее. За каждый час сверхурочно отработанного времени начисляется сумма в размере 150% от средней часовой ставки за предыдущий месяц. Средняя часовая ставка рассчитывается как сумма всех начислений за указанный период, поделенная на количество рабочих часов в этом периоде.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление по тарифу с 10.01 по 31.01, а запись: тариф с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за один расчетный период.

Для анализа сделанных сотрудникам предприятия начислений в конфигурации необходимо предусмотреть отчет следующего вида:

<table>
  <tr>
    <th rowspan="2">Подразделение</th>
    <th rowspan="2">Сотрудник</th>
    <th rowspan="2">Вид расчета</th>
    <th colspan="2">Период 1</th>
    <th colspan="2">Период 2</th>
    <th colspan="2">...</th>
  </tr>
  <tr>
    <th>Сумма в USD</th>
    <th>Сумма в EUR</th>
    <th>Сумма в USD</th>
    <th>Сумма в EUR</th>
    <th>...</th>
  </tr>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>Итого: </td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
</table>

Отчет может быть построен за любой расчетный период.


## Пояснения

Здесь я применяю следующую логику:
1. Сверхурочные часы мы выставляем для всего подразделения.
2. Сверхурочные часы - `основное начисление`, благодаря чему можно отметить, выходил человек или нет, например:
  - ставим свехурочные 01.05 (2 ч.) и 02.05 (2 ч.)
  - для сотрудника Бельдыев отмечаем, что он выходил на сверхурочные оба дня: 01.05 - 02.05 (период действия строки)
  - для сотрудника Васина отмечаем, что она выходила только 01.05: 01.05 - 01.05 (период действия строки)

Таким образом, не все сотрудники всего подразделения будут выходить сверхурочно. Кто вышел, тому поставили отметку с периодом выхода на сверхурочные. Кто не вышел, тому просто не вносят записи.

В итоге платится просто по факту того, сколько сверхурочных проработал человек (нет никакой нормы сверхурочных).


### Регистр сведений **ТарифнаяСтавка**
- добавляем измерения `Подразделение` (обязательное), `ЧасовОт` и `ЧасовДо` (обязательный)
- добавляем ресурс `ТарифнаяСтавка`

### Подразделения

Подразделения выполняют функцию `графиков работы`.


### Регистр сведений **Графики работы**

- добавляем измерение `Подразделение` (по аналогии со графиками работы в других билетах)
- переименовываем `Значение` в `Часов` (заполняется автоматически по коду в обработке `ЗаполнениеГрафика`), добавляем `ЧасовСверхурочно` (заполняем вручную по необходимости)


### Обработка **ЗаполнениеГрафика**

- Исправить заполнение графика: заполняем `Подразделение` (по аналогии со графиками работы в других билетах), `Часов` 


### План видов расчета **ОсновныеНачисления**

- Добавляем `Сверхурочные`, на вкладке `Базовые` выбираем "Оклад" и "Сверхурочные"
- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` (с какого по какое оклад и сверхурочные)
	- `Зависит по периоду действия` - "ОсновныеНачисления"


### Регистр расчета **ОсновныеНачисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - да
- стандартные измерение `Сотрудник` и ресурсы `РезультатДоллары, РезультатЕвро` (оплата), `ЧасовФакт` (для оклада - отработанные часы, для сверхурочных - сколько проработал; будет использоваться при расчете сверхурочных)
- Добавляем реквизиты:
	- `Подразделение, ТарифнаяСтавка` (для оклада)
		- если при подсчете `ЧасовФакт` будут показываться слишком большие цифры, то нужно установить связь реквизита `Подразделение` с измерением регистра `Подразделение`
	- `ОсноваДляНачислений, ЧасовЗаПрошлыйМесяц` (для сверхурочных)


  ### Документ **НачислениеЗарплаты**

- `Оперативное проведение` - **Запретить**
- в ТЧ "ОсновныеНачисления" добавляем поле `Подразделение` (если не было; выполняет функцию графика работы)
- для `Сверзурочные` заполняем базовый период

1. Начисление ЗП
- из `ДанныеГрафика` получаем количество отработанных часов
- соединяемся с регистром сведений `ТарифнаяСтавка` по подразделению + количеству отработанных часов:
```1c
  // ...
  ЕСТЬNULL(ТарифнаяСтавка.РазмерСтавки, 0) КАК ТарифнаяСтавка
ИЗ
  втДанныеГрафика КАК втДанныеГрафика
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТарифнаяСтавка КАК ТарифнаяСтавка
    ПО втДанныеГрафика.Подразделение = ТарифнаяСтавка.Подразделение
      И втДанныеГрафика.ЧасовФакт >= ТарифнаяСтавка.ЧасыОт
      И втДанныеГрафика.ЧасовФакт < ТарифнаяСтавка.ЧасыДо"
```

2. Начисление за сверхурочные
Соединяем `ДанныеГрафика` (номер строки + часов сверхурочных за этот месяц) с `БазаОсновныеНачисления` (РезультатДолларыБаза - выплаты за прошлый месяц - и ЧасовФактБаза - отработанные часы за прошлый месяц) по всем начислениям, после чего производим расчеты.

> Чтобы сверхурочные часы также шли в базу по отработанных часам, необходимо их записывать в ресурс `ЧасовФакт` (как и оклад)

3. Для расчета ЗП в евро необходимо получить курс конвертации из доллары в евро. С помощью запросов получаем последние данные по курсам, после чего рассчитываем курс конвертации.



### Отчет

Из `ФактическийПериодДействия` достаем необходимую информацию.
- можно в СКД настроить формат отображения периода действия

`РезультатДоллары, РезультатЕвро` выводим ресурсы.

Создаем таблицу:
- строки: Подразделение -> Сотрудник -> Вид расчета
- колонки: ПериодДействия
- в выбранные поля всего отчета выводим ресурсы



