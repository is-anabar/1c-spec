## Билет 10 (занятия 103-104)

Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается.

Сотрудники предприятия получают оплату по часовому тарифу. Сумма начисления по тарифу определяется как тарифная ставка, умноженная на количество фактически отработанных часов. 

За каждый день работы сотрудникам предприятия начисляется определенная сумма денег в качестве компенсации затрат на обеды. Компенсация за один обед рассчитывается как 5% от суммы начисления по тарифу в текущем расчетном периоде, деленная на количество рабочих дней в том же периоде.

Невыход сотрудника на работу без уважительной причины должен быть зафиксирован в информационной базе, но не оплачивается, может вводиться задним числом.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление по тарифу с 10.01 но 31.01, а запись: тариф с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

Для анализа начисленных сотрудникам предприятия компенсаций за обеды в конфигурации необходимо предусмотреть отчет следующего вида:
|Подразделение  | Сотрудник | Кол-во дней, за которые начислена комп-я  | Сумма компенсации |
|---------------|-----------|-------------------------------------------|-------------------|
|Отдел внедрения|		   |										   |					|	
|				|Иванов		|18											|630,00			 |
|			  	|Петров		|20										 |700,00			 |
|Бухгалтерия	|		   |										   |				   |			
|   			|Сидоров	|15											|300,00			 |


### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ ОсновныеНачисления + ДополнительныеНачисления), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления` и `ДополнительныеНачисления`


### Графики работы
Создаем справочник **ГрафикиРаботы**


### Обработка **ЗаполнениеГрафика**

- исправить заполнение графика: заполняем "ГрафикРаботы", "Часов" и "Дней"  


### План видов расчета **ОсновныеНачисления**

- добавляем `Невыход`
- для `Оклад` выбираем на вкладке `Вытесняющие` - "Невыход"
- выставляем на вкладке `Расчеты` флаги:
	- `Использует период действия` (с какого по какое оклад и невыход)
	- `Зависит по периоду действия` - "Не зависит"



### План видов расчета **Дополнительные начисления**

- выставляем на вкладке `Расчеты` флаги:
	- `Использует период действия` - нет
	- `Зависит по периоду действия` - "Основные начисления"
- добавляем `Компенсация на обеды`
- для `Компенсация на обеды` выставляем `Базовые` - "Оклад"


### Регистр расчета **Основные начисления**

- устанавливаем `Период действия`- да, заполняем поля
- стандартные измерение `Сотрудник` + `Подразделение` и ресурсы `Результат` + `ДнейФакт, ДнейПлан` (для расчета компенсаций на обеды)
- добавляем реквизиты `ГрафикРаботы, ЧасовФакт, ЧасовПлан, Оклад` (для оклада)
	- если при подсчете `ЧасовФакт и ЧасовПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `График работы` с измерением регистра `Графики работы`


### Регистр расчета **Дополнительные начисления**

- стандартные измерение `Сотрудник` + `Подразделение` и ресурс `Результат`
- добавляем реквизиты `ДнейФакт, ДнейПлан, ОсноваДляНачислений` (для компенсации)


### Документ **Начисление зарплаты**

Общий алгоритм расчета аналогичен [билету 9](/СПР/спр%20билет%209.md), отличается только расчет компенсации за обеды.

- `Оперативное проведение` - **Запретить**
- в ТЧ `ОсновныеНачисления` добавляем поле `ГрафикРаботы`
- добавляем ТЧ для дополнительных начислений 


1. Записываем все движения (в т.ч. сторно)
Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим
- для записей, введенных задним числом, добавляем движения с помощью таблицы дополнений.
```
ТаблицаДополнений = Движения.ОсновныеНачисления.ПолучитьДополнение();
```
При создании движений переносим в движение основные реквизиты - `ВидРасчета, Сотрудник, Подразделение, ГрафикРаботы, Оклад`. `Оклад` понадобится для сторнирования зарплаты (если брать актуальный, то там может выйти намного больше или намного меньше, чем нужно сторнировать).
- для ТЧ дополнительных начислений заполняем **базовый период** (для каждой строки - текущий месяц)

2. Расчет ЗП
Из `ДанныеГрафика` вытягиваем стандартную информацию: `номер строки`, `сотрудник, подразделение` (для отбора в РС по зарплате), `часов факт и план, дней план и факт`. Для правильного расчета сторнируемого оклада вытягиваем также `сторно и оклад`.

Получаем данные по окладу с учетом сторно:
```1c
ВЫБОР
	// если сторно, то берем оклад из периода сторно
	КОГДА втДанныеГрафика.Сторно
		ТОГДА втДанныеГрафика.Оклад
	ИНАЧЕ ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.Оклад, 0)
КОНЕЦ КАК Оклад
```

Отдельно обрабатываем `сторно`:
```1c
Если Движение.Сторно Тогда
	Движение.Результат = -1 * Движение.Результат;
	Движение.ДнейФакт = 0;
	Движение.ДнейПлан = 0;
КонецЕсли;
```

3. Расчет компенсации

Из РР `ДополнительныеНачисления` получаем данные по `БазаОсновныеНачисления`. Берем `НомерСтроки, ДнейФактБаза, ДнейПланБаза, РезультатБаза`. Рассчитываем компенсацию на обеды.


