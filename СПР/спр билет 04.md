## Билет 4 (занятия 78-81)


Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, т.е. совместительство допускается. 

Сотрудники каждого подразделения работают в три смены по графику «Сутки через двое».

Сотрудники предприятия получают оплату по часовому тарифу. Сумма начисления по тарифу определяется как тарифная ставка, умноженная на количество фактически отработанных часов. В течение расчетного периода тарифная ставка задается для каждой смены отдельно и может меняться каждый день. В информационной базе необходимо хранить историю ее изменения.

Руководителям подразделений выплачивается премия в виде процента от суммы оплат по тарифу за предыдущий месяц сотрудников его подразделения, за исключением оплаты самого руководителя. Ввод надбавки руководителю подразделения осуществляется документом «Начисление зарплаты». Информацию о должностях сотрудников в информационной базе хранить не надо.

Необходимо предоставить пользователю возможность самостоятельно создавать новые виды расчетов и привязывать их к существующим алгоритмам расчета.

Для анализа полученных сотрудниками предприятия премий в конфигурации необходимо предусмотреть отчет следующего вида:
- колонки Подразделение, Сотрудник, % премии, Сумма премии. 

Отчет должен быть построен только за определенный календарным месяц.

Создать отчет «Перерасчет зарплаты», в котором пользователь должен увидеть записи регистра расчета, которые возможно требуется пересчитать.

|Объект перерасчета| Вид расчета |Сотрудник |Подразделение |
|------------------|-------------|----------|--------------|
|														  |
			
Саму процедуру перерасчета записей в рамках данной задачи реализовывать не требуется. Ввод всех начислений происходит документом «Начисление зарплаты». Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление по тарифу с 10.01 по 31.01, а запись: тариф с 10.01 по 03.02 вводить нельзя.


### Перечисление **ВидыРасчетов**

Чтобы пользователи могли добавлять свои виды расчета, сделаем дополнительную информацию: рассчитывать как оклад или рассчитывать как премию. Для этого создадим перечисление со значениями:
- КакОклад
- КакПремия

### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ Основная), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления`


### Регистр сведений **ТарифнаяСтавка** (периодический - раз в день)
- добавляем измерения `ГрафикРаботы`
- добавляем ресурс `ТарифнаяСтавка`

### Регистр сведений **ГрафикиРаботы**

- Добавить измерение `ГрафикРаботы`
- Переименовать `Значение` в `Часов` 


### Обработка **ЗаполнениеГрафика**

Исправить заполнение графика: 
- заводим счет дней; текущий день смены расситываем как (СчетчикДней % 3) + 1
- для выходных 0, для рабочих - 24 (видимо)


### План видов расчета **ОсновныеНачисления**

- Добавляем реквизит `ВидРасчета` - перечисление `ВидыРасчетов`
- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` - да (с какого по какое оклад и сверхурочные)
	- `Зависит по периоду действия` - нет


### План видов расчета **Дополнительные**

- Добавляем реквизит `ВидРасчета` - перечисление `ВидыРасчетов`
- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` - нет
	- `Зависит по периоду действия` - "ОсновныеНачисления"
- Добавляем `Премия`:
	- на вкладке `Базовые` - Оклад
	- на вкладке `Ведущие` - Оклад (для перерасчетов)


### Регистр расчета **ОсновныеНачисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - нет
- стандартные измерения `Сотрудник` + `Подразделение` и ресурсы `Результат`
- Добавляем реквизиты `ГрафикРаботы, ТарифнаяСтавка, ЧасовФакт, ЧасовПлан`
	- если при подсчете `ЧасовФакт и ЧасовПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `ГрафикРаботы` с измерением регистра `ГрафикРаботы`


### Регистр расчета **ДополнительныеНачисления**

- устанавливаем `Период действия`- нет
- устанавливаем `Базовый период` - да, заполняем поля
- стандартные измерения `Сотрудник` + `Подразделение` и ресурсы `Результат`
- Добавляем реквизиты `ОсноваДляРасчетаПремии, ПроцентПремии`




### Документ **НачислениеЗарплаты**

- `Оперативное проведение` - **Запретить**
- в ТЧ "ОсновныеНачисления" добавляем поле "ГрафикРаботы"
- добавляем ТЧ для дополнительных начислений

1. Записываем все движения
Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим
- `Дополнительные начисления` переносим; для вида расчета `Командировка`:
	- заполняем **базовый период** (для каждой строки - два предыдущих месяца)
	- насильно записываем в график `Шестидневка`

2. Расчет ЗП
Расчет не отличается от стандартного, кроме одного момента: нужно **обязательно** делать отбор по `ВидРасчета.ВидРасчета` (КакОклад или КакПремия). При расчете ЗП берется вид `КакОклад` 


3. Расчет премии
При расчете нужно **обязательно** делать отбор по `ВидРасчета.ВидРасчета` (КакОклад или КакПремия). При расчете премии берется вид `КакПремия` 

Из `БазаДополнительныеНачисления` для `ДополнительныеНачисления` получаем информацию по премиb по измерениям `Подразделение` и по разрезу `Сотрудник`. Рукводителя отсекаем по условию `Сотрудник <> СотрудникРазрез`:

```1c
ВЫБРАТЬ
	ДополнительныеНачисленияБазаОсновныеНачисления.НомерСтроки КАК НомерСтроки,
	СУММА(ДополнительныеНачисленияБазаОсновныеНачисления.РезультатБаза) КАК ОсноваДляРасчетаПремии,
	ДополнительныеНачисленияБазаОсновныеНачисления.ПроцентПремии КАК ПроцентПремии
ИЗ
	РегистрРасчета.ДополнительныеНачисления.БазаОсновныеНачисления(
			&Измерения,
			&Измерения,
			&Разрезы,
			Регистратор = &Ссылка
				И ВидРасчета.ВидРасчета В (&ВидыРасчета)) КАК ДополнительныеНачисленияБазаОсновныеНачисления
ГДЕ
	// отсекаем руководителя
	ДополнительныеНачисленияБазаОсновныеНачисления.СотрудникРазрез <> ДополнительныеНачисленияБазаОсновныеНачисления.Сотрудник

СГРУППИРОВАТЬ ПО
	ДополнительныеНачисленияБазаОсновныеНачисления.НомерСтроки,
	ДополнительныеНачисленияБазаОсновныеНачисления.ПроцентПремии
```


### Перерасчеты

- Создаем для дополнительных начислений
- Измерения перерасчета такие же, как и у регистра расчета
	- `Измерение регистра` - какое измерение в текущем РР
	- `ДанныеВедущихРегистров` - какое измерение из регистра для расчета базы (здесь - ОсновныеНачисления)
