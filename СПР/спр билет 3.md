## Билет 3 (занятия 71-72, 73)

Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается.

Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам.

Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в днях. Дневная ставка рассчитывается как начальное значение оклада, деленное на количество рабочих дней в том же периоде, что и фактически отработанные дни. Первоначальное значение оклада может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода. В информационной базе необходимо хранить историю его изменения.

По мере необходимости любой сотрудник может быть отправлен в командировку.

В этом случае начисление по окладу не происходит. Часы, проведенные в командировке, определяются по шестидневному графику работы. Часовая ставка для расчета командировки определяется как сумма начислений по окладу за два предыдущих месяца, деленная на количество отработанных часов в двух предыдущих месяцах по основному месту работы. Следует учесть, что данные о командировке могут вводиться в систему задним числом.

~~По понедельникам, средам и пятницам по 2 часа времени уходит на вечерние часы. Часовая ставка за каждый вечерний час на 50% больше часовой ставки оклада.~~

~~Вечерние часы (командировка) рассчитываются также, как и для оклада.~~

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление оклада с 10.01 по 31.01, а запись оклад: с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

Для анализа сделанных сотрудникам предприятия начислений в конфигурации необходимо предусмотреть отчет следующего вида:
|Подразделение |Сотрудник |Вид расчета |Период1 |Период2 | … |
|--------------|----------|------------|--------|--------|---|
|Итого:                                                      |

Отчет может быть построен за любой расчетный период.


### Примечание

Решение было сделано без вечерних часов


### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ Основная), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления`


### Графики работы
Создаем справочник **ГрафикиРаботы**. Добавляем предопределенные элементы `Пятидневка`, `Шестидневка`


### Регистр сведений **ГрафикиРаботы**

- Добавить измерение `ГрафикРаботы`
- Переименовать `Значение` в `Часов` (для командировки), добавить ресурс `Дней` (для оклада)  


### Обработка **ЗаполнениеГрафика**

- Исправить заполнение графика: заполняем "ГрафикРаботы", "Часов" и "Дней" 


### План видов расчета **ОсновныеНачисления**

- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` (с какого по какое оклад и командировка)
	- `Зависит по периоду действия` - "ОсновныеНачисления"
- Добавляем `Командировка`, на вкладке `Базовые` выбираем "Оклад"
- Для `Оклад` выбираем на вкладке `Вытесняющие` - "Командировка"


### Регистр расчета **ОсновныеНачисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - да
- стандартные измерение `Сотрудник` + `Подразделение` (выставляем флажок *базовое*) и ресурсы `Результат` + `ЧасовФакт` (для расчета часов при расчете командировки)
- Добавляем реквизиты:
	- `ГрафикРаботы, Оклад, ДнейФакт и ДнейПлан` (для оклада)
		- если при подсчете `ДнейФакт и ДнейПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `График работы` с измерением регистра `Графики работы`
	- `ЧасовФактЗаПрошлыйПериод, НачисленоЗаПрошлыйПериод` (для командировки)


### Документ **НачислениеЗарплаты**

- `Оперативное проведение` - **Запретить**
- в ТЧ "ОсновныеНачисления" добавляем поле "ГрафикРаботы"


1. Записываем все движения (в т.ч. сторно)
Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим; для вида расчета `Командировка`:
    - заполняем **базовый период** (для каждой строки - два предыдущих месяца)
    - насильно записываем в график `Шестидневка`
- для записей, введенных задним числом, добавляем движения с помощью таблицы дополнений.
```
ТаблицаДополнений = Движения.ОсновныеНачисления.ПолучитьДополнение();
```
При создании движений переносим в движение основные реквизиты - `ВидРасчета, Сотрудник, Подразделение, ГрафикРаботы, Оклад`. `Оклад` понадобится для сторнирования зарплаты (если брать актуальный, то там может выйти намного больше или намного меньше, чем нужно сторнировать).


2. Расчет ЗП
Из `ДанныеГрафика` вытягиваем стандартную информацию: `номер строки`, `сотрудник, подразделение` (для отбора в РС по зарплате), `часов факт и план, дней факт`. Для правильного расчета сторнируемого оклада вытягиваем также `сторно и оклад`.

Получаем данные по окладу с учетом сторно:
```1c
ВЫБОР
	// если сторно, то берем оклад из периода сторно
	КОГДА втДанныеГрафика.Сторно
		ТОГДА втДанныеГрафика.Оклад
	ИНАЧЕ ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.Оклад, 0)
КОНЕЦ КАК Оклад
```

При расчете результата учитываем вид начислений.

Отдельно обрабатываем `сторно`:
```1c
Если Движение.Сторно Тогда
	Движение.Результат = -1 * Движение.Результат;
	Движение.ДнейФакт = 0;
КонецЕсли;
```

> Когда-то мной в коде (и по видео Леонтьева) сделано не обнуление `ЧасовФакт`, в минусование. По идее, обнуление будет более верным, т.к. за счет вытеснения часы сами уменьшатся.


### Отчет

Из `ОсновныеНачисления` достаем необходимую информацию.
- можно в СКД настроить формат отображения периода действия

`Результат` выводим ресурсы.

Создаем таблицу:
- строки: Подразделение -> Сотрудник -> Вид расчета
- колонки: ПериодДействия
- в выбранные поля всего отчета выводим ресурсы

