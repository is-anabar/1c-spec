## Билет 8 (занятие 107, 119 - расчет премии начальнику бригады)


Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно только в одной бригаде, то есть совместительство не допускается.

Все сотрудники работают только по пятидневному графику работы.

Сотрудники предприятия получают оплату по часовому тарифу. Сумма начисления по тарифу определяется как тарифная ставка, умноженная на количество фактически отработанных часов. В момент начисления значения тарифной ставки определяется пользователем самостоятельно и заносится в документ «Начисление зарплаты».

Сотрудникам предприятия выплачивается надбавка, рассчитываемая как общая сумма продаж товаров за предыдущий квартал по бригаде, в которой работает сотрудник, умноженная на определенный процент. Значение процента в течение периода начисления не меняется и задается в документе «Начисление зарплаты».

Помимо надбавки, начальникам бригад выплачивается премия в виде процента от надбавки сотрудника своей бригады, получившего максимальную сумму надбавки. Ввод премии начальнику бригады осуществляется документом «Начисление зарплаты».

Информацию о должностях сотрудников в информационной базе хранить не надо.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление по тарифу с 10.01 по 31.01, а запись тариф: с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

Для анализа полученных сотрудниками предприятия надбавок в конфигурации необходимо предусмотреть отчет следующего вида:

|Бригада |Сотрудник |Сумма продаж |% надбавки |Сумма премии|
|--------|----------|-------------|-----------|------------|
|Итого:	|

Отчет может быть построен за любой расчетный период.


### Подразделения / бригады

Совместительства нет, поэтому убираем подразделения там, где они есть. Информация о бригаде будет носить только справочный характер.


### Графики работы
Так как все работает по 5/2, то создание справочника не требуется.


### Регистр сведений **Графики работы**

- переименовываем `Значение` в `Часов`


### Обработка **Заполнение графика**

Без изменений.


### План видов расчета **Основные начисления**

- на вкладе **Расчеты** ставим:
	- `Использует период действия` - да (для оклада)
	- `Зависит по периоду действия` - нет


### План видов расчета **Дополнительные начисления**

- на вкладе **Расчеты** ставим:
	- `Использует период действия` - нет
	- `Зависит по периоду действия` - дополнительные начисления (премия начальнику зависит от обычных премий)
- добавляем `Премия начальнику`; выставляем на вкладке `Базовые` - `Премия`


### Регистр расчета **Основные начисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - нет
- стандартные измерение `Сотрудник` и ресурс `Результат`
- добавляем реквизиты `Подразделение, ЧасовФакт, ТарифнаяСтавка` (для оклада)


### Регистр расчета **Дополнительные начисления**

- устанавливаем `Период действия`- нет
- устанавливаем `Базовый период` - да, заполняем поля
- стандартные измерение `Сотрудник` и ресурс `Результат`
- добавляем реквизиты `Подразделение, ОсноваДляНачислений, Процент` (для премии и премии начальнику)


### Документ **Начисление зарплаты**

- `Оперативное проведение` - **Запретить**
- добавляем ТЧ для дополнительных начислений 

1. Записываем все движения
Пробегаем по всем ТЧ документа:
- `Основные начисления` и `ДополнительныеНачисления` переносим
- для `ДополнительныеНачисления - премия начальнику` заполняем **базовый период** (для каждой строки - текущий месяц)

2. Расчет ЗП
Получаем фактические часы и тарифную ставку, рассчитываем результат

3. Расчет премии
- из `ДополнительныеНачисления` получаем информацию о строках с премией
- соединяемся с информацией о продажах за прошлый квартал (может быть как оборотный регистр накопления, так и регистр бухгалтерии)
- рассчитываем премию

4. Расчет премии начальнику
Из `БазаДополнительныеНачисления` для `ДополнительныеНачисления` получаем информацию по премия по измерениям `Подразделение` (хоть это и ресурс) и по разрезу `Сотрудник`:
```1c
// Получаем информацию по подразделению в разрезе сотрудника
ВЫБРАТЬ
	ДополнительныеНачисленияБазаДополнительныеНачисления.НомерСтроки КАК НомерСтроки,
	ДополнительныеНачисленияБазаДополнительныеНачисления.РезультатБаза КАК РезультатБаза,
	ДополнительныеНачисленияБазаДополнительныеНачисления.СотрудникРазрез КАК СотрудникРазрез
ПОМЕСТИТЬ втДанныеПоПремиям
ИЗ
	РегистрРасчета.ДополнительныеНачисления.БазаДополнительныеНачисления(
			&Измерения,
			&Измерения,
			&Разрезы,
			Регистратор = &Ссылка
				И ВидРасчета В (&ВидыРасчетаПремияНачальнику)) КАК ДополнительныеНачисленияБазаДополнительныеНачисления
;

////////////////////////////////////////////////////////////////////////////////
// Получаем максимум по бригаде / подразделению
ВЫБРАТЬ
	втДанныеПоПремиям.НомерСтроки КАК НомерСтроки,
	МАКСИМУМ(втДанныеПоПремиям.РезультатБаза) КАК ОсноваДляНачислений
ИЗ
	втДанныеПоПремиям КАК втДанныеПоПремиям

СГРУППИРОВАТЬ ПО
	втДанныеПоПремиям.НомерСтроки
```

> В видео 117 используется только первый запрос для получения результата. У меня не вышло: если убрать `СотрудникРазрез`, то всегда выводилась только сумма всех премий, даже если поставить МАКСИМУМ(). Поэтому была сделана временная таблица с разбиением по сотрудникам, после чего был найден максимум.

Производим расчет премии руководителю (процент можно взять из движения).


