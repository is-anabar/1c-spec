## Билет 7 (занятия 107 - 108)

Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается.

Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам.

Количество фактически отработанных часов вводится в систему с помощью документа «Табель». Документ должен заполняться на список сотрудников только определенного подразделения. Для каждого сотрудника, на каждый день месяца, вводится количество фактически отработанных часов на основном месте работы и в командировке.

Затем в задании будет представлен внешний вид формы табеля.
На форме в шапке документа поля «Номер», «Дата», «Подразделение».
Ниже табличная часть. В ней колонки «Сотрудник» и «1», «2», «3»...
В колонке «Сотрудник» отображается список сотрудников, а на пересечении сотрудника и дня месяца один из трех вариантов: «8», «8К» либо пустое поле.

Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в часах. Часовая ставка рассчитывается как начальное значение оклада, деленное на количество рабочих часов в том же периоде, что и фактически отработанные часы. Первоначальное значение оклада может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода. В информационной базе необходимо хранить историю его изменения.

По мере необходимости любой сотрудник может быть отправлен в командировку. В этом случае начисление по окладу не происходит. Часы, проведенные в командировке, определяются по пятидневному графику работы, исходя из 40 часовой рабочей недели.

Часовая ставка для расчета командировки определяется как сумма всех начислений за два предыдущих месяца, деленная на количество рабочих часов в двух предыдущих месяцах. Следует учесть, что данные о командировке не могут вводиться в систему задним числом.

Механизм перерасчетов в рамках данной задачи использовать не надо.

Ввод всех начислений происходит документом «Начисление зарплаты». Документ в расчетном периоде может быть один (сразу для всех видов расчета), а может быть несколько (по одному для каждого отдельного вида расчета). Считать, что все данные вводятся только в пределах одного месяца, например, можно указать начисление оклада с 10.01 по 31.01, а запись оклад: с 10.01 по 03.02 вводить нельзя. В одном документе могут быть данные только за текущий расчетный период.

Для анализа сделанных сотрудникам предприятия начислений в конфигурации необходимо предусмотреть отчет следующего вида:
|Подразделение |Сотрудник |Вид расчета |Период 1 |Период 2 |… |
|--------------|----------|------------|---------|---------|--|
|Итого:													   |
					
Отчет может быть построен за любой расчетный период.


### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ Основная), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления`


### Графики работы
Создаем справочник **ГрафикиРаботы**

### Регистр сведений **ГрафикиРаботы**

- Добавить измерение `ГрафикРаботы`
- Переименовать `Значение` в `Часов` 

### Обработка **ЗаполнениеГрафика**

- исправить заполнение графика: заполняем "ГрафикРаботы", "Часов"


### План видов расчета **ОсновныеНачисления**

- Добавляем `Командировка`, на вкладке `Базовые` выбираем "Оклад" и "Командировка"
- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` (с какого по какое оклад и командировка)
	- `Зависит по периоду действия` - "ОсновныеНачисления"


### Регистр расчета **ОсновныеНачисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - да
- стандартные измерение `Сотрудник` и ресурсы `Результат`, `ЧасовФакт` (для оклада - отработанные часы, для командировки - сколько был в командировке; будет использоваться при расчете командировки)
- Добавляем реквизиты:
	- `ГрафикРаботы, ЧасовПлан, Оклад` (для оклада)
		- если при подсчете `ЧасовФакт и ЧасовПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `ГрафикРаботы` с измерением регистра `ГрафикРаботы`
	- `ОсноваДляНачислений, ЧасовБазовыйПериод` (для командировки)


### Регистр накопления (оборотный) **ДанныеТабеля**

- измерения `Сотрудник, Подразделение, ВидРасчета`
- ресурсы `Часов`


### Документ **Табель**

Заводим табличную часть, где в колонках будет:
- Сотрудник
- День1 ... День31 (строка)

При проведении документа:
- определяем дней в месяце - с помощью `День(<КонецМесяца>)`
- по виду записи (пусто, 8 или 8К) определяем вид начисления и записываем строку в РН `ДанныеТабеля`:
	- для пусто - никаких записей
	- 8 - оклад
	- 8К - командировка

### Документ **НачислениеЗарплаты**

- `Оперативное проведение` - **Запретить**
- в ТЧ "ОсновныеНачисления" добавляем поле "ГрафикРаботы"


1. Записываем все движения
Пробегаем по всем ТЧ документа:
- `Основные начисления` переносим. Для вида расчета `Командировка`:
	- заполняем **базовый период** (для каждой строки - два предыдущих месяца)
	- насильно записываем в график `Пятидневка`

2. Расчет ЗП
- получить данные графика для оклада:
	- `ЧасовПлан` (он рассчитывается исходя из указанного графика)
	- `ПериодДействияНачало, ПериодДействияКонец` (для получение фактических часов из РН)
- соединиться с:
	- данными табеля (по подразделению + сотруднику, виду часов, периоду - между периодом действия начало и конец)
	- с данными по окладу (по подразделению + сотруднику)
- получаем сумму часов, максимум из оклада и часов план (они будут дублироваться для каждой строки с `ЧасовФакт`)

Далее рассчет результата стандартный.

3. Расчет командировки
- получить данные графика для командировки:
	- `ЧасовФактическийПериодДействия` (он рассчитывается исходя из пятидневки)
- соединяемся с:
	- БазаОсновныеНачисления (по номеру строки)
- получаем `РезультатБаза` (основа для начислений), `ЧасовФактБаза` (часов за базовый период)

Далее рассчет результата стандартный.


