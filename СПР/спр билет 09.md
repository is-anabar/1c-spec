## Билет 9 (занятия 98-99)


Начисление методом отклонений. Все работают по одному графику, но нужно предусмотреть возможность работы по нескольким графикам. Сотрудники могут работать в разных подразделениях.

Оклад по часам. Ставка часовая меняется раз в месяц и берётся на начало расчетного периода. 

Больничный. Рассчитывается как количество дней болезни умноженное на среднюю дневную ставку. Средняя дневная ставка = Сумма оклада, начисленного за предыдущий месяц, деленная на количество рабочих дней в том же месяце.

Перерасчеты использовать не нужно. 

В одном документе Начисление ЗП может быть и оклад и больничный. Данные могут вводиться задним числом. Оклад вводится всегда в пределах месяца. Больничный можно вводить с 25.01 по 10.02 одной строкой.

Для анализа сделанных сотрудникам предприятия начислений в конфигурации необходимо предусмотреть отчет следующего вида:

|Подразделение	|Сотрудник	|Дней болезни	|Сумма начисленного больничного	|
|---------------|-----------|---------------|-------------------------------|
|				|			|				|								|			



### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ Основная), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления`


### Графики работы
Создаем справочник **ГрафикиРаботы**


### Регистр сведений **ГрафикиРаботы**

- Добавить измерение `ГрафикРаботы`
- Переименовать `Значение` в `Часов`, добавить ресурс `Дней` (для больничного)   


### Обработка **ЗаполнениеГрафика**

- Исправить заполнение графика: заполняем "ГрафикРаботы", "Часов" и "Дней"  


### План видов расчета **ОсновныеНачисления**

- Добавляем `Больничный`, на вкладке `Базовые` выбираем "Оклад"
- Для `Оклад` выбираем на вкладке `Вытесняющие` - "Больничный"
- Выставляем на вкладке "Расчеты" флаги:
	- `Использует период действия` (с какого по какое оклад и больничные)
	- `Зависит по периоду действия` - "ОсновныеНачисления"


### Регистр расчета **ОсновныеНачисления**

- устанавливаем `Период действия`- да, заполняем поля
- устанавливаем `Базовый период` - да
- стандартные измерение `Сотрудник` + `Подразделение` и ресурс `Результат`
- Добавляем реквизиты:
	- `ГрафикРаботы, Оклад, ЧасовФакт и ЧасовПлан` (для оклада)
		- если при подсчете `ЧасовФакт и ЧасовПлан` будут показываться слишком большие цифры, то нужно установить связь реквизита `График работы` с измерением регистра `Графики работы`
	- `ОсноваДляВыплат, ДнейФакт, ДнейПлан` (для больничного)


### Документ **НачислениеЗарплаты**

- `Оперативное проведение` - **Запретить**
- в ТЧ "ОсновныеНачисления" добавляем поле "ГрафикРаботы"


1. **Разбить больничный по периодам**
Перебираем все строки в ТЧ Основная для документа.

Чтобы определить, больничный задевает 1 месяц или больше, необходимо в конструкторе запросов узнать разницу между последним и первым днем больничного (в месяцах)
```1c
РАЗНОСТЬДАТ(
    НачислениеЗарплатыОсновныеНачисления.ДатаНачала,    
    КОНЕЦПЕРИОДА(НачислениеЗарплатыОсновныеНачисления.ДатаОкончания, МЕСЯЦ), 
    МЕСЯЦ
)
```
После этого пробегаем все строки:
- Если это больничный, то записываем `БазовыйПериодНачало` и `БазовыйПериодКонец` как месяц **до начала больничного**
- Если больничный занимает несколько разных месяцев, то разбиваем на промежутки по месяцам:
```1c
Для Итерация = 0 По Выборка.РазностьМесяцев Цикл
	// определяем текущий месяц для записи
	НачалоМесяца = ДобавитьМесяц(НачалоМесяца(Выборка.ПериодДействияНачало), Итерация);
	КонецМесяца = КонецМесяца(НачалоМесяца);

	// ...
	
	// начало текущей записи - максимум из начала больничного 
	// и начала текущего месяца
    Движение.ПериодДействияНачало = Макс(Выборка.ПериодДействияНачало, НачалоМесяца);  
    // конец текущей записи - минимум из конца больничного
    // и окончания текущего месяца
	Движение.ПериодДействияКонец = Мин(Выборка.ПериодДействияКонец, КонецМесяца);
```
- Для остальных видов расчета просто создаем движение и переносим данные из ТЧ

2. **Внести сторно-записи**
Для записей, введенных задним числом, добавляем движения с помощью таблицы дополнений.
```
ТаблицаДополнений = Движения.ОсновныеНачисления.ПолучитьДополнение();
```
При создании движений переносим в движение основные реквизиты - `Сотрудник, Подразделение, ГрафикРаботы, ВидРасчета, Оклад`. `Оклад` понадобится для сторнирования зарплаты (если брать актуальный, то там может выйти намного больше или намного меньше, чем нужно сторнировать).

3. **Рассчитать оклад с учетом сторно**
Из `ДанныеГрафика` вытягиваем стандартную информацию: `номер строки`, `сотрудник, подразделение` (для отбора в РС по зарплате), `часов факт и план`. Для правильного расчета сторнируемого оклада вытягиваем также `сторно и оклад`.

Получаем данные по окладу с учетом сторно:
```1c
ВЫБОР
	// если сторно, то берем оклад из периода сторно
	КОГДА втДанныеГрафика.Сторно
		ТОГДА втДанныеГрафика.Оклад
	ИНАЧЕ ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.Оклад, 0)
КОНЕЦ КАК Оклад
```
Далее расчет зарплаты стандартен. Для `сторно` умножаем результат на `-1`.

4. **Рассчитать больничный**
Из `ДанныеГрафика` вытягиваем информацию по `дням факт и план` (только для больничного). Соединяемся с `БазаОсновныеНачисления` и достаем основу для начислений - `РезультатБаза`. Рассчитываем больничный пропорционально дням.