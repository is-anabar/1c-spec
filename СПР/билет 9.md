## Билет 9 (занятия 98-99)


### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ Основная), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления`


### Графики работы
Создаем справочник **ГрафикиРаботы**


### Регистр сведений **ГрафикиРаботы**

- Добавить измерение `ГрафикРаботы`
- Переименовать "Значение" в `Часов`, добавить ресурс `Дней` (для больничного)   


### Обработка **ЗаполнениеГрафика**

- Исправить заполнение графика: заполняем "ГрафикРаботы", "Часов" и "Дней"  


### План видов расчета **ОсновныеНачисления**

- Добавляем `Больничный`, на вкладке `Базовые` выбираем "Оклад"
- Для `Оклад` выбираем на вкладке `Вытесняющие` - "Больничный"
- Выставляем на вкладке "Расчеты" флаги:
	- "ИспользуетПериодДействия" (с какого по какое оклад и больничные)
	- "Зависит по периоду действия" - "ОсновныеНачисления"


### Регистр расчета **ОсновныеНачисления**

- На вкладке "Основная" выставляем флаг `Период действия`, `Базовый период`. Заполняем поля
- Добавляем реквизиты:
	- "ГрафикРаботы", "Оклад", "ЧасовФакт" и "ЧасовПлан" (для оклада), 
	- "ОсноваДляВыплат", "ДнейФакт", "ДнейПлан" (для больничного)


### Документ **НачислениеЗарплаты**:

- `Оперативное проведение` - "Запретить"
- в ТЧ "ОсновныеНачисления" добавляем поле "ГрафикРаботы"


1. **Разбить больничный по периодам**
Перебираем все строки в ТЧ Основная для документа.

Чтобы определить, больничный задевает 1 месяц или больше, необходимо в конструкторе запросов узнать разницу между последним и первым днем больничного (в месяцах)
```1c
РАЗНОСТЬДАТ(
    НачислениеЗарплатыОсновныеНачисления.ДатаНачала,    
    КОНЕЦПЕРИОДА(НачислениеЗарплатыОсновныеНачисления.ДатаОкончания, МЕСЯЦ), 
    МЕСЯЦ
)
```
После этого пробегаем все строки:
- Если это больничный, то записываем `БазовыйПериодНачало` и `БазовыйПериодКонец` как месяц **до начала больничного**
- Если больничный занимает несколько разных месяцев, то разбиваем на промежутки по месяцам:
```1c
Для Итерация = 0 По Выборка.РазностьМесяцев Цикл
	// определяем текущий месяц для записи
	НачалоМесяца = ДобавитьМесяц(НачалоМесяца(Выборка.ПериодДействияНачало), Итерация);
	КонецМесяца = КонецМесяца(НачалоМесяца);

	// ...
	
	// начало текущей записи - максимум из начала больничного 
	// и начала текущего месяца
    Движение.ПериодДействияНачало = Макс(Выборка.ПериодДействияНачало, НачалоМесяца);  
    // конец текущей записи - минимум из конца больничного
    // и окончания текущего месяца
	Движение.ПериодДействияКонец = Мин(Выборка.ПериодДействияКонец, КонецМесяца);
```
- Для остальных видов расчета просто создаем движение и переносим данные из ТЧ

2. **Внести сторно-записи**
Для записей, введенных задним числом, добавляем движения с помощью таблицы дополнений.
```
ТаблицаДополнений = Движения.ОсновныеНачисления.ПолучитьДополнение();
```
При создании движений переносим в движение основные реквизиты - `Сотрудник, Подразделение, ГрафикРаботы, ВидРасчета, Оклад`. `Оклад` понадобится для сторнирования зарплаты (если брать актуальный, то там может выйти намного больше или намного меньше, чем нужно сторнировать).

3. **Рассчитать оклад с учетом сторно**
Из `ДанныеГрафика` вытягиваем стандартную информацию: `номер строки`, `сотрудник, подразделение` (для отбора в РС по зарплате), `часов факт и план`. Для правильного расчета сторнируемого оклада вытягиваем также `сторно и оклад`.

Получаем данные по окладу с учетом сторно:
```1c
ВЫБОР
	// если сторно, то берем оклад из периода сторно
	КОГДА втДанныеГрафика.Сторно
		ТОГДА втДанныеГрафика.Оклад
	ИНАЧЕ ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.Оклад, 0)
КОНЕЦ КАК Оклад
```
Далее расчет зарплаты стандартен. Для `сторно` умножаем результат на `-1`.

4. **Рассчитать больничный**
Из `ДанныеГрафика` вытягиваем информацию по `дням факт и план` (только для больничного). Соединяемся с `БазаОсновныеНачисления` и достаем основу для начислений - `РезультатБаза`. Рассчитываем больничный пропорционально дням.