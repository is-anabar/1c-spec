## Билет 16 (занятия 90, 91 - c 32:00 по 53:30)

Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений. Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается.

Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам.

Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в часах. Часовая ставка рассчитывается как начальное значение оклада, деленное на количество рабочих часов в том же периоде, что и фактически отработанные часы. Первоначальное значение оклада определяется пользователем самостоятельно и заносится в документ «Начисление зарплаты».

За каждый отработанный день в течение периода начисления сотрудникам предприятия полагается фиксированная сумма денег в качестве компенсации затрат на разговоры по мобильному телефону. Данная ставка едина для всех сотрудников компании и должна быть зафиксирована в информационной базе.

Создать отчет «Перерасчет зарплаты», в котором пользователь должен иметь возможность увидеть записи регистра расчета, которые возможно требуется пересчитать. В отчете должна быть возможность выполнить процедуру перерасчета записей.

|Объект перерасчета	|Вид расчета |… |
|---|---|---|



### Подразделения

Т.к. есть **совместительство**, то заводим `Подразделение` в документе `НачислениеЗарплаты` (ТЧ ОсновныеНачисления + ДополнительныеНачисления), регистре сведений `СведенияОСотрудниках`, регистре расчета `ОсновныеНачисления` и `ДополнительныеНачисления`


### ГрафикиРаботы
Создаем справочник ГрафикиРаботы


### Регистр сведений ГрафикиРаботы
- Добавить измерение `ГрафикРаботы`
- Переименовать `Значение` в `Часов`
- Добавить ресурс `Дней` (для компенсации за мобильный) 


### Обработка ЗаполнениеГрафика
- дополнительно заполняем ГрафикРаботы и Дней


### Создаем константу БазоваяСтавкаКомпенсации


### План видов расчета ОсновныеНачисления
- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - да
	- `Зависит по периоду действия` - нет

### План видов расчета ДополнительныеНачисления
- Выставляем на вкладке Расчеты флаги:
	- `ИспользуетПериодДействия` - нет
	- `Зависит по периоду действия` - ОсновныеНачисления (для получения основы для расчета компенсации)
- Добавляем **Компенсация**
	- На вкладке `Базовые` выбираем Оклад


### Регистр расчета ОсновныеНачисления
- На вкладке Основная выставляем флаг `Период действия`. Заполняем поля
- Добавляем измерения Сотрудник, Подразделение (базовые)
- Добавляем ресурс `ДнейФакт` (компенсация за телефон)
- Добавляем реквизиты `Оклад`,  `ЧасовФакт, ЧасовПлан` (оба - для оклада) и `ДнейФакт` (компенсация за телефон)


### Регистр расчета ДополнительныеНачисления
- На вкладке Расчеты выставляем флаг `Базовый период`
- Добавляем реквизиты `ДейФакт и БазоваяСтавкаКомпенсации`


### Перерасчеты:
- Создаем для **дополнительных начислений**
- Измерения перерасчета такие же, как и у регистра расчета (сотрудник + подразделение)
- Измерение регистра - какое измерение в текущем РР, ДанныеВедущихРегистров - какое измерение из базы
- В плане видов расчета выставляем для **Компенсации** на вкладке `Ведущие` - Оклад



### Примечание
Для создание отчета необходимо сделать некоторые предварительные действия:
- создаем общий модуль (флаги `сервер + внешнее соединение`)

### Документ НачислениеЗарплаты
- Оперативное проведение - Запретить
- Добавляем в ТЧ ОсновныеНачисления поле ГрафикРаботы
- Добавляем табличную часть для дополнительных начислений


1. Записываем все движения

	Пробегаем по всем ТЧ документа:
	- `Основные начисления` переносим.
	- `Дополнительные начисления` переносим. Для вида расчета `Компенсация`:
		- заполняем **базовый период** (для каждой строки - текущий месяц)

2. Расчет ЗП

	2.1 Создаем в общем модуле экспортную процедуру `ЗаполнитьОсновныеНачисления(НаборЗаписей, Регистратор)` 
	- в качестве НаборЗаписей будут передаваться `Движения.ОсновныеНачисления`
	- в качестве Регистратор - `Ссылка`

	2.2 Начисление ЗП - стандартное

3. Расчет компенсации

	3.1. Создаем в общем модуле экспортную процедуру `ЗаполнитьДополнительныеНачисления(НаборЗаписей, Регистратор, ТаблицаОтборов = Неопределено)`
	- в качестве НаборЗаписей будут передаваться `Движения.Дополнительные`
	- в качестве Регистратор - `Ссылка`
	- в качестве ТаблицаОтборов - данные `Подразделение + Сотрудник`, которые нужно рассчитать (из документа всегда передается Неопределено; таблица будет 	заполняться в отчете)
	
	3.2. Начисление компенсации

	- Определяем, мы сейчас перерасчитываем документ или нет: 
	```1c
	ЭтоПерерасчеты = (ТаблицаОтборов <> Неопределено);
	```
	- Выборка для дополнительных начислений стандартная, только нужно добавить отбор:
	```1c	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДополнительныеНачисленияБазаОсновныеНачисления.НомерСтроки КАК НомерСтроки,
		|	ДополнительныеНачисленияБазаОсновныеНачисления.ДнейФактБаза КАК ДнейФакт
		|ИЗ
		|	РегистрРасчета.ДополнительныеНачисления.БазаОсновныеНачисления(
		|			&Измерения,
		|			&Измерения,
		|			,
		|			Регистратор = &Ссылка
		|				И ВидРасчета В (&ВидыРасчета)
		|				И &ДополнительноеУсловие) КАК ДополнительныеНачисленияБазаОсновныеНачисления";
	
	Если ЭтоПерерасчеты Тогда
		ДополнительноеУсловие = "(Сотрудник, Подразделение) В (&ТаблицаОтборов)"
	Иначе
		ДополнительноеУсловие = "ИСТИНА";
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ДополнительноеУсловие", ДополнительноеУсловие);
	```
	- Далее просто рассчитываем компенсацию


### Отчет

1. Форма отчета

	- Создаем свою форму отчета
	- Добавляем в реквизиты формы `Результат` (табличный документ)
	- Добавляем команду `Перерассчитать`:
		- выносим на форму
		- создаем процедуры на клиенте и сервере

2. Получение `ТаблицаОтборов` для перерассчета компенсации

	- С помощью запроса получаем данные о документе, сотруднике, подразделении (итоги по документу), которые надо перерассчитать
	- Создаем таблицу отборов (шаблон)
	```1c
	ТаблицаОтборов = Новый ТаблицаЗначений; 
	ТаблицаОтборов.Колонки.Добавить("Сотрудник", Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	ТаблицаОтборов.Колонки.Добавить("Подразделение", Новый ОписаниеТипов("СправочникСсылка.Подразделения"));
	```
	- Заполняем таблицу отборов
	```1c
	// Обходим все документы
	Пока ВыборкаИтог.Следующий() Цикл
		
		// Обходим все записи в документах
		Выборка = ВыборкаИтог.Выбрать();
		ТаблицаОтборов.Очистить();
		
		// Заполняем данные для отбора
		Пока Выборка.Следующий() Цикл
			Строка = ТаблицаОтборов.Добавить();
			ЗаполнитьЗначенияСвойств(Строка, Выборка);
		КонецЦикла;
		
		// Создаем набор записей для перерасчета
		НаборЗаписей = РегистрыРасчета.ДополнительныеНачисления.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаИтог.ОбъектПерерасчета);
		НаборЗаписей.Прочитать();
		
		ПерерасчетыСервер.ЗаполнитьДополнительныеНачисления(НаборЗаписей, ВыборкаИтог.ОбъектПерерасчета, ТаблицаОтборов);
		
	КонецЦикла;
	```
	- Для автоматического обновления отчета добавляем в конце
	```1c
	СкомпоноватьРезультат();
	```