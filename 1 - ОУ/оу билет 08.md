# Билет 8 (занятия 35, 36)

Компания занимается оптовой торговлей. Все операции отражаются документами «Приходная накладная», «Расходная накладная», «Приход денег» и «Расход денег», причем для каждого из них может быть указана своя статья затрат. Таким образом, документ «Расход денег» может отражать операции, например, по оплате поставщику или возврата от покупателя в зависимости от выбранной статьи затрат.

Структурно компания состоит из нескольких подразделений. В целях ведения управленческого учета для каждого отдела заводится бюджет (документ «Бюджет») на  произвольный месяц период (указывается в шапке документа) с указанием всех предполагаемых статей затрат, сумм по ним и возможного превышения этих сумм в суммовом выражении. Следует считать, что каждое подразделение может вводить несколько документов «Бюджет», данные которых должны суммироваться для формирования итогового бюджета.

В целях контроля над исполнением бюджета при проведении любого документа должен происходить анализ фактических затрат и выводится соответствующее предупреждение, в случае превышения над бюджетом. Например, если по статье «оплата поставщикам» запланировано 100 000 и 20 000, то при суммарной оплате более 100 000 и более 120 000 должны быть выданы соответствующие предупреждения.

Можно считать, что документы задним числом не вводятся, но существующие документы могут быть перепроведены.

Необходимо создать отчет по исполнению бюджета за период, кратный месяцу.

![report](/1%20-%20ОУ/media/ticket-8-report.png)


## Статьи затрат

Создаем справочник `Статьи затрат`

## Регистр накопления

Для храния данных по бюджету создаем регистр накопления `Бюджеты`. Он будет `оборотным`, т.к. нельзя гарантировать, что бюджет за месяц всегда будет списан в ноль.
- Оборотный
- Измерения:
    - Подразделение
    - Статья затрат
- Ресурсы:
    - Сумма (основной бюджет)
    - Сумма превышения (дополнительный бюджет)
    - Сумма исполнения (сколько по факту потрачено)


## Документ Бюджет

Создаем документ.

Реквизиты:
- Подразделение

Табличная часть:
- Статья затрат
- Сумма
- Сумма превышения


Для проведения документа можно воспользоваться конструктором движений.


### Начисление бюджета

В задаче может быть указано `на произвольный период (указывается в шапке документа)`. Чтобы не услжнять себе задачу, можно считать, что произвольный период - месяц, в который нужно записать бюджет. 

Создаем реквизит `Период` и записываем бюджет на начало месяца.


## Документ Расходная накладная


Здесь описана настройка только этого документа. Необходимо настроить и другие документы из решения.

Добавляем реквизиты:
- Подразделение
- Статья затрат


Аналогично билету с [расчетом аванса](оу%20билет%2014.md), сначала записываем траты, а потом проверяем превышение.

## Запись расходов по бюджету

```1c
// записываем расходы по бюджету	
Движение = Движения.Бюджеты.Добавить();
Движение.Период = Дата;
Движение.Подразделение = Подразделение;
Движение.СтатьяЗатрат = СтатьяЗатрат;
Движение.СуммаИсполнения = СуммаПоДокументу;
	
Движения.Бюджеты.Записывать = Истина;
Движения.Бюджеты.БлокироватьДляИзменения = Истина;
Движения.Бюджеты.Записать();
```

## Вывод предупреждения

Необходимо получить данные по оборотам по бюджету (за месяц) и рассчитать, насколько был превышен бюджет.

```1c
Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
    // сколько выделено по основному бюджету
	|	БюджетыОбороты.СуммаОборот КАК СуммаОборот,
    // сколько выделено дополнительно
	|	БюджетыОбороты.СуммаПревышенияОборот КАК СуммаПревышенияОборот,
    // сколько потрачено по факту
	|	БюджетыОбороты.СуммаИсполненияОборот КАК СуммаИсполненияОборот
	|ИЗ
	|	РегистрНакопления.Бюджеты.Обороты(
	|			&НачалоМесяца,
	|			&КонецМесяца,
	|			,
	|			Подразделение = &Подразделение
	|				И СтатьяЗатрат = &СтатьяЗатрат) КАК БюджетыОбороты";
	
// установка параметров и выборка...
	
Пока Выборка.Следующий() Цикл
	АбсолютноеПревышениеБюджета = Выборка.СуммаИсполненияОборот - (Выборка.СуммаОборот + Выборка.СуммаПревышенияОборот);
	ПревышениеОсновногоБюджета = Выборка.СуммаИсполненияОборот - Выборка.СуммаОборот;
    // если превысили бюджет совсем, то выводим одно сообщение
	Если АбсолютноеПревышениеБюджета > 0 Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон("Весь бюджет на месяц превышен на %1", АбсолютноеПревышениеБюджета);
		Сообщение.Сообщить();
    // если превысили только основной бюджет - другое
	ИначеЕсли ПревышениеОсновногоБюджета > 0 Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон("Основной бюджет превышен на %1", ПревышениеОсновногоБюджета);
		Сообщение.Сообщить();
	КонецЕсли;
КонецЦикла;
```


## Подготовка кода для любого документа

Так как по условию нужно сделать проверку для всех документов, то:
- код по проверке выносим в отдельный общий модуль
- в документах вызываем общий метод


### Общий модуль

Создаем общий модуль - `сервер`.

Необходимые данные будем получать из переданного объекта.


```1c
Процедура ПроверитьБюджет(Объект, Отказ) Экспорт 
    // движения документа
	Движения = Объект.Движения;
    // реквизиты документа
	Дата = Объект.Дата;
	Подразделение = Объект.Подразделение;
	СтатьяЗатрат = Объект.СтатьяЗатрат; 
	СуммаПоДокументу = Объект.СуммаПоДокументу;

    // просто переносим код из Расходной накладной
КонецПроцедуры
```


### Расходная накладная

Вызываем общий метод в `ОбработкаПроведения`. В качестве параметров передаем текущий документ - `ЭтотОбъект` - и `Отказ`.

```1c
Процедура ПровестиОУ(Отказ)
	ОбщегоНазначения.ПроверитьБюджет(ЭтотОбъект, Отказ);
КонецПроцедуры
```


## Отчет

Получаем информацию по оборотам:

```1c
ВЫБРАТЬ
	БюджетыОбороты.Период КАК Период,
	БюджетыОбороты.Подразделение КАК Подразделение,
	БюджетыОбороты.СтатьяЗатрат КАК СтатьяЗатрат,
	БюджетыОбороты.СуммаОборот КАК План,
	БюджетыОбороты.СуммаИсполненияОборот КАК Факт,
	ВЫБОР
		КОГДА БюджетыОбороты.СуммаОборот = 0
			ТОГДА 100
		ИНАЧЕ БюджетыОбороты.СуммаИсполненияОборот / БюджетыОбороты.СуммаОборот * 100
	КОНЕЦ КАК ПроцентИсполнения
ИЗ
    // выбираем периодичность Месяц для того, чтобы вывести Период
	РегистрНакопления.Бюджеты.Обороты(&НачалоПериода, &КонецПериода, Месяц, ) КАК БюджетыОбороты
```

Чтобы посторить отчет, необходимо:
- На вкладке `Ресурсы` добавить План, Факт и ПроцентИсполнения
- Создать отчет в виде таблицы, где:
    - Строки:
        - (группировка) Подразделение
            - (группировка) Статья затрат
    - Колонки:
        - (группировка) Период
    - Выбранные поля:
        - План
        - Факт
        - ПроцентИсполнения