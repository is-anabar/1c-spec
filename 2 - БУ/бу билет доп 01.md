# Билет 1 дополнительный (Кролики)

Необходимо создать документ «Операция», с помощью которого пользователь должен иметь возможность ввести проводки с произвольной корреспонденцией счетов. При решении задачи следует учесть возможность наличия проводок, сформированных с помощью данного документа.

Организация занимается разведением и продажей животных. Для описания каждого животного к нему добавляется произвольное количество характеристик. Набор этих характеристик является свойством. Например: кролик «мясной, крупный» или кролик «меховой, крупный, белый». «Мясной», «белый» - это характеристики, а «меховой, крупный, белый» - это свойство. Учет ведется в разрезе свойств животных. Механизм должен быть реализован с помощью плана вида характеристик.

Поступление животных отражается документом «Приходная накладная», формирующим следующие проводки:
- Дт «Товары» - Кт «Поставщики» - на вес и сумму закупленных животных.

Откорм животных отражается пользователем самостоятельно документом «Операция», формирующим  следующие проводки:
- Дт «Товары» - Кт «Поставщики» - на привес животных.
 
Продажа животных отражается документом «Расходная накладная», формирующим  следующие проводки:
 
- Дт «Прибыли и убытки» - Кт «Товары» - на вес и сумму себестоимости,
- Дт «Покупатели» - Кт «Прибыли и убытки» - на сумму в продажных ценах.
 
Себестоимость рассчитывается как средняя по свойству номенклатуры.

Необходимо построить отчет о продажах животных в разрезе характеристик.
 
![report](/2%20-%20БУ/media/ticket-extra-1-report.png)



## Свойства кроликов

Создаем справочник `СвойстваКроликов`. Для созданного справочника задаем значения характеритик. Пример можно взять [здесь](/0%20-%20общее/03%20как%20добавить%20характеристики%20объектов.md).


## Настройка плана счетов

<!-- настройка 
0 - общее\05 как заполнить регистр бухгалтерии.md
Простой учет остатков товаров -->

Настройка похожа на [настройку простого списания товаров](/0%20-%20общее/05%20как%20заполнить%20регистр%20бухгалтерии.md)

### Общая настройка 

- Количество субконто: 2
- Признаки учета:
	- Количественный (аналог веса)

### Настройка счетов

Товары (используется как аналог регистра по остаткам):
- Количественный: `да`
- Субконто:
	- Номенклатура
	- Свойства кроликов

Прибыли убытки (используется как аналог регистра для продаж):
- Количественный: `нет`
- Субконто:
	- Номенклатура: `только обороты`
    - Свойства кроликов: `только обороты`


## Настройка регистра бухгалтерии

Необходимо выполнить [базовые настройки](/0%20-%20общее/05%20как%20заполнить%20регистр%20бухгалтерии.md) и настройки [простого учета остатков](/0%20-%20общее/05%20как%20заполнить%20регистр%20бухгалтерии.md)

Ресурсы:
- Количество:
	- `Небалансовый`
	- признак учета: `Количественный`


## Приходная накладная


Для формирования движений можно воспользоваться конструктором движений.




## Расходная накладная


### Установка флагов записи движений

```1c
// очищаем движения - записываем пустые
Движения.Управленческий.Записывать = Истина;
Движения.Записать();

// устанавливаем флажок, чтобы новые движения записывались
Движения.Управленческий.Записывать = Истина;
```

### Запрос


Формируем запрос для списания товаров:
- группируем данные из документа
- получаем остатки по паре `номенклатура - свойство кролика`

```1c
ВЫБРАТЬ
	// группировка данных из документа
	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
	РасходнаяНакладнаяСписокНоменклатуры.СвойствоКролика КАК СвойствоКролика,
	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Вес) КАК Вес,
	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
ПОМЕСТИТЬ втТовары
ИЗ
	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
ГДЕ
	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка

СГРУППИРОВАТЬ ПО
	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
	РасходнаяНакладнаяСписокНоменклатуры.СвойствоКролика

ИНДЕКСИРОВАТЬ ПО
	Номенклатура,
	СвойствоКролика
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	втТовары.Номенклатура КАК Номенклатура,
	втТовары.Номенклатура.Представление КАК НоменклатураПредставление,
	втТовары.СвойствоКролика КАК СвойствоКролика,
	втТовары.СвойствоКролика.Представление КАК СвойствоКроликаПредставление,
	// данные из документа
	втТовары.Вес КАК Вес,
	втТовары.Сумма КАК Сумма,
	// получение остатков
	ЕСТЬNULL(УправленческийОстатки.ВесОстаток, 0) КАК ВесОстаток,
	ЕСТЬNULL(УправленческийОстатки.СуммаОстаток, 0) КАК СуммаОстаток
ИЗ
	втТовары КАК втТовары
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Управленческий.Остатки(
				&МоментВремени,
				Счет = &СчетТовары,
				&ВидыСубконто,
				(Субконто1, Субконто2) В
					(ВЫБРАТЬ
						втТовары.Номенклатура КАК Номенклатура,
						втТовары.СвойствоКролика КАК СвойствоКролика
					ИЗ
						втТовары КАК втТовары)) КАК УправленческийОстатки
		ПО втТовары.Номенклатура = УправленческийОстатки.Субконто1
			И втТовары.СвойствоКролика = УправленческийОстатки.Субконто2
```


### Блокировка

Устанавливаем блокировку

Блокировка устанавливается `ПЕРЕД` запросом. 

Блокируем данные по остакам (для левого соединения):
- по счету
- по списку номенклатуры
- по списку свойств

```1c
Блокировка = Новый БлокировкаДанных;
ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
ЭлементБлокировки.УстановитьЗначение("Счет", Счета.Товары);
// блокируем по списку номенклатуры и свойств
ЭлементБлокировки.ИсточникДанных = СписокНоменклатуры;
ЭлементБлокировки.ИспользоватьИзИсточникаДанных(Субконто.Номенклатура, "Номенклатура");
ЭлементБлокировки.ИспользоватьИзИсточникаДанных(Субконто.СвойствоКролика, "СвойствоКролика");
Блокировка.Заблокировать();
```



## Отчет

```1c
ВЫБРАТЬ
	ВЫРАЗИТЬ(УправленческийОбороты.Субконто1 КАК Справочник.Номенклатура) КАК Номенклатура,
	УправленческийОбороты.СуммаОборотДт КАК Себестоимость,
	УправленческийОбороты.СуммаОборотКт КАК ПродажаСумма,
	СвойстваКроликов.ЗначениеХарактеристикиКролика КАК Характеристика,
	УправленческийОбороты.ВесКорОборот КАК ПродажаВес
ИЗ
	РегистрБухгалтерии.Управленческий.Обороты(&НачалоПериода, &КонецПериода, , Счет = &СчетПрибылиУбытки, &ВидыСубконто, , КорСчет В (&СписокКорСчетов), ) КАК УправленческийОбороты
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СвойстваКроликов КАК СвойстваКроликов
		// делаем отбор в левом соединении
		//
		// если сделать отбор в левом + ГДЕ, то получится внутренее соединение
		ПО УправленческийОбороты.Субконто2 = СвойстваКроликов.СвойствоКролика
			И (СвойстваКроликов.ХарактеристикаКролика = &Характеристика)
```

Параметры:
```1c
&ВидыСубконто - Номенклатура, Свойства кроликов
&СпискоКорСчетов - Товары, Покупатели
```



