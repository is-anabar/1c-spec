# Билет 13 (занятие 56)

Необходимо создать документ «Операция», с помощью которого пользователь должен иметь возможность ввести проводки с произвольной корреспонденцией счетов. При решении задач следует учитывать возможность наличия проводок, сформированных с помощью данного документа.

Требуется организовать возможность учета продажи комплектов. В системе должна храниться информация о составе комплекта (какие номенклатурные позиции и в каком количестве входят в данный комплект). В состав комплекта не могут входить другие комплекты. Следует обеспечить уникальность деталей в рамках комплектов, т.е. одна и та же деталь не должна входить в состав разных комплектов.

Операция сборки как таковая в компании не осуществляется. Когда покупатель приходит получать комплект ответственный сотрудник компании в соответствии со спецификацией отгружает необходимое количество комплектующих.
Продажи осуществляются документом «Расходная накладная». В табличной части документа указываются комплекты и их количество.

Документ реализует следующие проводки:
- Дт «Прибыли и убытки» - Кт «Товары» на количество и себестоимость списываемых комплектующих.

В случае продажи комплекта необходимо списать его комплектующие согласно составу комплекта
- Дт «Покупатели» - Кт «Прибыли и убытки» на сумму в продажных ценах.

Себестоимость рассчитывается как средняя по номенклатурной позиции на складе.

Необходимо построить отчет по продажам комплектов за период.

Продажи комплектов за период с 01.01.2010 по 31.01.2010
|Комплект	|Продажа	|Себестоимость|
|-----------|-----------|-------------|
|Комплект № 1	|500 000	|200 000|
|Комплект № 3	|620 000	|350 000|


## Документ Операция 

Можно прочитать [здесь](/0%20-%20общее/04%20как%20создать%20документ%20Операция%20или%20ее%20аналоги.md)


## Учет комплектов


### Виды номенклатуры

Исправляем перечисление `ВидыНоменклатуры`. Делаем элементы `Комплект` и `Деталь`.

### Настройка номенклатуры

Добавляем реквизит `Тип`

### Регистр сведений для комплектов

Для того, чтобы деталь была только в одном комплекте, в качестве измерения будет деталь.

Создаем регистр сведений `СоставКомплектов`:
- непериодический
- измерения:
    - Деталь: устанавливаем `связь по типу` Отбор.Тип(Деталь)
- ресурсы:
    - Комплект: устанавливаем `связь по типу` Отбор.Тип(Комплект)
    - Количество


## Настройка Виды Субконто

### Склады

Создаем справочник `Склады`.

### Типы субконто

Добавляем:
- Номенклатура
- Склад


## Настройка плана счетов

<!-- настройка 
0 - общее\05 как заполнить регистр бухгалтерии.md
Простой учет остатков товаров -->

### Общая настройка 

- Количество субконто: 2
- Признаки учета:
	- Количественный

### Настройка счетов

Товары (используется как аналог регистра по остаткам):
- Количественный: `да`
- Субконто:
	- Номенклатура
	- Склад

Прибыли убытки (используется как аналог регистра для продаж):
- Количественный: `нет`
- Субконто:
	- Номенклатура: `только обороты`


## Настройка регистра бухгалтерии

Необходимо выполнить [базовые настройки](/0%20-%20общее/05%20как%20заполнить%20регистр%20бухгалтерии.md)

Дополнительно:
- Ресурсы:
	- Количество:
		- `Небалансовый`
		- признак учета: `Количественный`


## Приходная накладная

Добавляем реквизит `Склад`.

Для `Номенклатура` устанавливаем `связь по типу` Отбор.Тип(Деталь)

Для формирования движений можно воспользоваться конструктором движений.


## Расходная накладная

Добавляем реквизит `Склад`.

Для `Номенклатура` устанавливаем `связь по типу` Отбор.Тип(Комплект)


### Установка флагов записи движений

```1c
// очищаем движения - записываем пустые
Движения.Управленческий.Записывать = Истина;
Движения.Записать();

// устанавливаем флажок, чтобы новые движения записывались
Движения.Управленческий.Записывать = Истина;
```

### Блокировка

Чтобы правильно заблокировать регистр, необходимо разделить комплекты на детали.

```1c
// данные запросов будут использованы далее для получения остатков;
// чтобы не потерять результат, записываем его в менеджер временных таблиц
МВТ = Новый МенеджерВременныхТаблиц;
	
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МВТ;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Комплект,
	|	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
	|	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
	|ПОМЕСТИТЬ втКомплекты
	|ИЗ
	|	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
	|ГДЕ
	|	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Комплект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
    |   // получаем состав комплектов
	|ВЫБРАТЬ
	|	втКомплекты.Комплект КАК Комплект,
	|	втКомплекты.Количество КАК Количество,
	|	втКомплекты.Сумма КАК Сумма,
	|	СоставКомплектов.Деталь КАК Деталь,
	|	ЕСТЬNULL(СоставКомплектов.Количество, 0) КАК КоличествоДеталейВКомплекте
	|ПОМЕСТИТЬ втДетали
	|ИЗ
	|	втКомплекты КАК втКомплекты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоставКомплектов КАК СоставКомплектов
	|		ПО втКомплекты.Комплект = СоставКомплектов.Комплект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
    |   // выводим данные о деталях для блокировки
	|ВЫБРАТЬ
	|	втДетали.Деталь КАК Деталь
	|ИЗ
	|	втДетали КАК втДетали";
	
Запрос.УстановитьПараметр("Ссылка", Ссылка);
РезультатЗапроса = Запрос.Выполнить();  
	
// блокировка деталей
Блокировка = Новый БлокировкаДанных;
ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
ЭлементБлокировки.УстановитьЗначение("Счет", ПланыСчетов.Управленческий.Товары);
// используем в качестве списка деталей результат запроса
ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
ЭлементБлокировки.ИспользоватьИзИсточникаДанных(ПланыВидовХарактеристик.ВидыСубконто.Номенклатура, "Деталь");
ЭлементБлокировки.УстановитьЗначение(ПланыВидовХарактеристик.ВидыСубконто.Склады, Склад);
Блокировка.Заблокировать();
```

### Формирование движений

С помощью `менеджера временных таблиц` были сохранены запросы о комплектах, деталях и пр. Можно достать информацию об остатках.

```1c
Запрос = Новый Запрос;
// используем виртуальные таблицы из прошлого запроса
Запрос.МенеджерВременныхТаблиц = МВТ;
Запрос.Текст = 
	"ВЫБРАТЬ
    |   // за счет использования МВТ сохранились временные таблицы
	|	втКомплектыРазложенные.Комплект КАК Комплект,
	|	втКомплектыРазложенные.Деталь КАК Деталь,
	|	втКомплектыРазложенные.КоличествоДеталей КАК КоличествоДеталей,
	|	втКомплектыРазложенные.Сумма КАК Сумма,
	|	ЕСТЬNULL(УправленческийОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(УправленческийОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
	|	втКомплектыРазложенные.Деталь.Представление КАК ДетальПредставление
	|ИЗ
	|	втКомплектыРазложенные КАК втКомплектыРазложенные
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Управленческий.Остатки(
	|				&МоментВремени,
	|				Счет = &СчетТовары,
	|				&ВидыСубконто,
	|				Субконто1 В
	|						(ВЫБРАТЬ
	|							втКомплектыРазложенные.Деталь КАК Деталь
	|						ИЗ
	|							втКомплектыРазложенные КАК втКомплектыРазложенные)
	|					И Субконто2 = &Склад) КАК УправленческийОстатки
	|		ПО втКомплектыРазложенные.Деталь = УправленческийОстатки.Субконто1
    |   // продажи формируются для комплектов
	|ИТОГИ
	|	МАКСИМУМ(Сумма)
	|ПО
	|	Комплект";
```

После этого можно формировать движения.

```1c
ВыборкаКомлект = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаКомлект.Следующий() Цикл
		
		Выборка = ВыборкаКомлект.Выбрать();
		Пока Выборка.Следующий() Цикл
			// недостаточно товаров
			Если Выборка.КоличествоДеталейДляКомплекта > Выборка.КоличествоОстаток Тогда
				Отказ = Истина;
				
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = СтрШаблон("Для комплекта %1 недостаточно делатей %2 в количестве %3",
					Выборка.КомплектПредставление,
					Выборка.ДетальПредставление,
					Выборка.КоличествоДеталейДляКомплекта - Выборка.КоличествоОстаток);
				Сообщение.Сообщить(); 
			КонецЕсли;
			
			// не задан состав комплекта
			Если Выборка.КоличествоДеталейДляКомплекта = 0 Тогда
				Отказ = Истина;
				
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = СтрШаблон("Не задан состав комплекта %1", Выборка.КомплектПредставление);
				Сообщение.Сообщить();
			КонецЕсли; 
			
			Если Отказ Тогда 
				Продолжить;
			КонецЕсли;
			
			Если Выборка.КоличествоДеталейДляКомплекта = Выборка.КоличествоОстаток Тогда
				Себестоимость = Выборка.СуммаОстаток;
			Иначе
				Себестоимость = Выборка.КоличествоДеталейДляКомплекта * Выборка.СуммаОстаток / Выборка.КоличествоОстаток;
			КонецЕсли; 
			
			// списание деталей
			Движение = Движения.Управленческий.Добавить(); 
			Движение.Период = Дата; 
			// дт
			Движение.СчетДт = ПланыСчетов.Управленческий.ПрибылиУбытки;
            // продаем комплекты
			Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = ВыборкаКомлект.Комплект;
			// кт
			Движение.СчетКт = ПланыСчетов.Управленческий.Товары;
            // списываем детали
			Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Деталь;
			Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Склады] = Склад;
			Движение.КоличествоКт = Выборка.КоличествоДеталейДляКомплекта;
			// общее
			Движение.Сумма = Себестоимость; 
		КонецЦикла;
		
		// продажи
		// списание деталей
		Движение = Движения.Управленческий.Добавить(); 
		Движение.Период = Дата;
		// дт
		Движение.СчетДт = ПланыСчетов.Управленческий.Покупатели;
		// кт
		Движение.СчетКт = ПланыСчетов.Управленческий.ПрибылиУбытки;
		Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = ВыборкаКомлект.Комплект;
		// общее
		Движение.Сумма = ВыборкаКомлект.Сумма;
	КонецЦикла;
```



## Отчет

```1c
ВЫБРАТЬ
	УправленческийОбороты.Субконто1 КАК Комплект,
	УправленческийОбороты.СуммаОборотДт КАК Себестоимость,
	УправленческийОбороты.СуммаОборотКт КАК Продажа
ИЗ
	РегистрБухгалтерии.Управленческий.Обороты(&НачалоПериода, &КонецПериода, , Счет = &СчетПрибылиУбытки, &ВидыСубконто, , КорСчет В (&СписокКорСчетов), ) КАК УправленческийОбороты
```

Параметры:
```1c
&ВидыСубконто - Номенклатура
&СпискоКорСчетов - Товары, Покупатели
```
