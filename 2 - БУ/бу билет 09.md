# Билет 61 (занятие 61)

Необходимо создать документ «Операция», с помощью которого пользователь должен иметь возможность вести проводки с произвольной корреспонденцией счетов. При решении задачи следует учитывать возможность наличия проводок, сформированных с помощью данного документа.

Необходимо реализовать возможность торговли товара с использованием агентов. Т.е. товар может продаваться самостоятельно (обычным порядком) и через агента. В обоих случаях используется документ «Расходная накладная». При продаже через агента заполняется дополнительный реквизит шапки «Агент».

Продажа через агента заключается в том, что агент «приводит» клиента в компанию. Таким образом, в документе «Расходная накладная» в качестве контрагента указывается реальный покупатель. В табличной части указываются цены, по которым покупатель приобретает товарные позиции. Агент получает вознаграждение в виде 20% от разницы между продажной стоимостью и себестоимостью проданных с его участием позиций. Сама выплата вознаграждения агенту отражается ручной операцией.

Учет ведется в рублях, а с агентами дополнительно ведется в валюте, причем для каждого агента установлена своя собственная валюта, не подлежащая пересмотру. При начислении вознаграждения агенту, валютная сумма определяется исходя из рублевой суммы, валюты агента и курса, установленного для данной валюты на дату документа.

Документ «Расходная накладная» делает следующие проводки:
- Дт «Прибыли и убытки» - Кт «Товары» на количество и себестоимость товара;
- Дт «Покупатели» - Кт «Прибыли и убытки» на сумму продажи.

В случае если товар продается через агента, то делается дополнительная проводка:
- Дт «Прибыли и убытки» - Кт «Агенты» на сумму вознаграждения агента.

Документ не должен проводиться в случае, если каких-либо из указанных товаров не хватает. Учет товаров ведется в разрезе складов. Себестоимость рассчитывается как средняя по номенклатурной позиции на складе.

![report](/2%20-%20БУ/media/ticket-9-report.png)



## Документ Операция 

Можно прочитать [здесь](/2%20-%20БУ/общее/04%20как%20создать%20документ%20Операция%20или%20ее%20аналоги.md)

## Настройка Виды Субконто

### Склады

Создаем справочник `Склады`.

### Типы субконто

Добавляем:
- Номенклатура
- Склады
- Агенты (физические лица)


## Настройка плана счетов

<!-- настройка 
0 - общее\05 как заполнить регистр бухгалтерии.md
Простой учет остатков товаров -->

Для настройки нужно использовать:
- [учет в валюте](/2%20-%20БУ/общее/05%20как%20заполнить%20регистр%20бухгалтерии.md#учет-в-валюте)
- [просто учет остатков](/2%20-%20БУ/общее/05%20как%20заполнить%20регистр%20бухгалтерии.md#простой-учет-остатков-товаров)

### Общая настройка 

- Количество субконто: 2
- Признаки учета:
	- Количественный
	- Валютный

### Настройка счетов

Товары:
- Количественный: `да`
- Валютный: `нет`
- Субконто:
	- Номенклатура
	- Склад

Агенты:
- Количественный: `нет`
- Валютный: `да`
- Субконто:
	- Агенты

Прибыли убытки:
- Количественный: `нет`
- Валютный: `нет`
- Субконто: можно не заполнять


## Настройка регистра бухгалтерии

Необходимо выполнить [базовые настройки](/2%20-%20БУ/общее/05%20как%20заполнить%20регистр%20бухгалтерии.md)

Итого:
- Ресурсы:
	- Количество:
		- `Небалансовый`
		- признак учета: `Количественный`
	- СуммаРуб:
		- `Балансовый`
	- СуммаВал:
		- `Небалансовый`
		- признак учета: `Валютный`


## Приходная накладная

Для формирования движений можно воспользоваться конструктором движений.


## Расходная накладная

Добавляем реквизит `Агент`.


### Установка флагов записи движений

```1c
// очищаем движения - записываем пустые
Движения.Управленческий.Записывать = Истина;
Движения.Записать();

// устанавливаем флажок, чтобы новые движения записывались
Движения.Управленческий.Записывать = Истина;
```


### Запрос

Здесь просто получаем остатки по складу.

```1c
ВЫБРАТЬ
	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
ПОМЕСТИТЬ втТовары
ИЗ
	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
ГДЕ
	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
	И РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуре = &Товар

СГРУППИРОВАТЬ ПО
	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура

ИНДЕКСИРОВАТЬ ПО
	Номенклатура
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	втТовары.Номенклатура КАК Номенклатура,
	втТовары.Номенклатура.Представление КАК НоменклатураПредставление,
	втТовары.Количество КАК Количество,
	втТовары.Сумма КАК Сумма,
	ЕСТЬNULL(УправленческийОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	ЕСТЬNULL(УправленческийОстатки.СуммаРубОстаток, 0) КАК СуммаРубОстаток
ИЗ
	втТовары КАК втТовары
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Управленческий.Остатки(
				&МоментВремени,
				Счет = &СчетТовары,
				&ВидыНоменклатуры,
				Субконто1 В
						(ВЫБРАТЬ
							втТовары.Номенклатура КАК Номенклатура
						ИЗ
							втТовары КАК втТовары)
					И Субконто2 = &Склад) КАК УправленческийОстатки
		ПО втТовары.Номенклатура = УправленческийОстатки.Субконто1
```

### Формирование движений

```1c
Пока Выборка.Следующий() Цикл
	Разница = Выборка.Количество - Выборка.КоличествоОстаток;
	Если Разница > 0 Тогда 
		Отказ = Истина;
			
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон("На складе недостаточно товара %1 в количестве %2",
		Выборка.НоменклатураПредставление, Разница);
		Сообщение.Сообщить();
	КонецЕсли;
		
	Если Отказ Тогда
		Продолжить;
	КонецЕсли;
		
	Если Выборка.Количество = Выборка.КоличествоОстаток Тогда
		Себестоимость = Выборка.СуммаРубОстаток;
	Иначе
		Себестоимость = Выборка.Количество * Выборка.СуммаРубОстаток / Выборка.СуммаРубОстаток; 
	КонецЕсли;
		
	// списание
	//
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = дата;
	// дт
	Движение.СчетДт = Счета.ПрибылиУбытки;
	// кт
	Движение.СчетКт = Счета.Товары;
	Движение.СубконтоКт[Субконто.Номенклатура] = Выборка.Номенклатура;
	Движение.СубконтоКт[Субконто.Склады] = Склад;
	Движение.КоличествоКт = Выборка.Количество;
	// общее
	Движение.СуммаРуб = Себестоимость; 
		
	// продажи
	//
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = дата;
	// дт
	Движение.СчетДт = Счета.Покупатели;
	// кт 
	Движение.СчетКт = Счета.ПрибылиУбытки;
	// общее
	Движение.СуммаРуб = Выборка.Сумма;
		
	// начисление контрагентам
	//
	Если ЗначениеЗаполнено(Агент) Тогда
		// здесь необходимо проверить:
		// у агента есть валюта (лучше через запрос)
		// если не задана, то отказ

		// нужно проверить, что задан курс валюты
		// если нет, то отказ
			
		Выручка = Выборка.Сумма - Себестоимость;
		ПроцентВыплаты = 0.2;
			
		СуммаВал = Окр(ПроцентВыплаты * Выручка / КурсВалюты, 2); 
		СуммаРуб = ПроцентВыплаты * Выручка;

		// проверка, чтобы не записывать лишнее пустое движение
		Если СуммаРуб = 0 И СуммаВал = 0 Тогда
			Продолжить;
		КонецЕсли;
			
		Движение = Движения.Управленческий.Добавить();
		Движение.Период = дата;
		// дт
		Движение.СчетДт = Счета.ПрибылиУбытки;
		// кт
		Движение.СчетКт = Счета.Агенты;
		Движение.СубконтоКт[Субконто.Агенты] = Агент;
		Движение.СуммаВалКт = СуммаВал;
		// общее
		Движение.СуммаРуб = ПроцентВыплаты * Выручка;
	КонецЕсли;
		
КонецЦикла;
```

### Блокировка

Устанавливаем блокировку

Блокировка устанавливается `ПЕРЕД` запросом. 

Блокируем данные по остакам (для левого соединения):
- по счету
- по списку номенклатуры
- по складу

```1c
Блокировка = Новый БлокировкаДанных;
ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
// блокировка по счету
ЭлементБлокировки.УстановитьЗначение("Счет", Счета.Товары);
// блокировка по списку номенклатура
ЭлементБлокировки.ИсточникДанных = Основная;
ЭлементБлокировки.ИспользоватьИзИсточникаДанных(Субконто.Номенклатура, "Номенклатура");
// блокировка по складу
ЭлементБлокировки.УстановитьЗначение(Субконто.Склады, Склад);
Блокировка.Заблокировать();
```

## Отчет

```1c
ВЫБРАТЬ
	УправленческийОстатки.Субконто1 КАК Агент,
	// делаем ВЫРАЗИТЬ(), чтобы не было лишних левых соединений
	// с остальными типами субконто
	ВЫРАЗИТЬ(УправленческийОстатки.Субконто1 КАК Справочник.ФизическиеЛица).Валюта КАК Валюта,
	УправленческийОстатки.СуммаВалОстатокКт КАК СуммаВалюта,
	УправленческийОстатки.СуммаРубОстатокКт КАК СуммаРубли
ИЗ
	РегистрБухгалтерии.Управленческий.Остатки(&Период, Счет = &СчетАгенты, &ВидыСубконто, ) КАК УправленческийОстатки
```

