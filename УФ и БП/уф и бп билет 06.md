## Билет 6 (занятия 120)

Организовать хранение продажных цен деталей в разрезе типов цен (оптовые, розничные и т.д.) в документе «Расходная накладная» необходимо иметь возможность указывать тип цен, по которым осуществляется отпуск товара. В форме выбора деталей, для каждой детали, дополнительно необходимо отражать ее цену (согласно указанному в документе типу цен), а так же текущий остаток на складе. Склад, как и тип цен, указывается в шапке документа «Расходная накладная». При выборе детали в документ должна добавляться не только сама деталь, но и соответствующая цена.



### Справочник **ТипыЦен**

Создаём справочник `ТипыЦен`

### Регистр сведений **ЦеныНоменклатуры**

Создаём РС:
- периодический - в пределах дня
- измерения: номенклатура, тип цены
- ресурс - цена


### Документ **РасходнаяНакладная**

1. Добавляем реквизиты для типа цен и склада

2. Добавляем обработку `НачалоВыбора` для номенклатуры:
	```1c
	Процедура СписокНоменклатурыНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
		СтандартнаяОбработка = Ложь; 
		
		ТекущиеДанные = Элементы.СписокНоменклатуры.ТекущиеДанные;
		
		ПараметрыФормы = Новый Структура;
		// передаются как параметры для запроса
		ПараметрыФормы.Вставить("ТипЦены", Объект.ТипЦены);
		ПараметрыФормы.Вставить("Склад", Объект.Склад);
		// для того, чтобы при открытии формы мы позиционаровались на 
		// текущей номенклатуре
		ПараметрыФормы.Вставить("ТекущаяСтрока", ТекущиеДанные.Номенклатура); 
		// указываем 3-ий параметр - владелец
		// без него обработка оповещения не будет работать
		ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаВыбораРасширенная", ПараметрыФормы, Элементы.СписокНоменклатуры);
	КонецПроцедуры
	```

3. Добавляем `ОбработкаВыбора` для номенклатуры (то, что возвращает список номенклатуры):
	```1c
	Процедура СписокНоменклатурыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
		// в ВыбранноеЗначение будет передаваться структура, об этом далее
		ТекущиеДанные = Элементы.СписокНоменклатуры.ТекущиеДанные;
		ЗаполнитьЗначенияСвойств(ТекущиеДанные, ВыбранноеЗначение);
	КонецПроцедуры
	```


### Расширенная форма выбора номенклатуры

1. Для справочника Номенклатура создаём `ФормаВыбора` (не устанавливаем основной).

	На форме:
	- для реквизита формы `Список` устанавливаем флажок `Произвольный запрос`
	- исправляем запрос: `Номенклатура` соединяется с `ЦеныНоменклатуры` (по типу цены) и остатками номенклатуры (может быть как остаточный регистр, так и регистр бухгалтерии - по складу) 
	- устанавливаем справочник Номенклатура как `Основная таблица` (под текстом запроса)
	- устанавливаем флажок `Динамическое считывание данных` (там же)

2. Устанавливаем параметры запроса при создании формы на сервере:
	```1c
	Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка) 
		ТипЦены = Неопределено;
		Параметры.Свойство("ТипЦены", ТипЦены);
		Список.Параметры.УстановитьЗначениеПараметра("ТипЦены", Параметры.ТипЦены);
		
		Склад = Неопределено;
		Параметры.Свойство("Склад", Склад);
		Список.Параметры.УстановитьЗначениеПараметра("Склад", Параметры.Склад);
	КонецПроцедуры
	```

3. Добавляем обработку, которая срабатывает при выборе строки списка - `ВыборЗначения`:
	```1c
	Процедура СписокВыборЗначения(Элемент, Значение, СтандартнаяОбработка)
		ТекущиеДанные = Элементы.Список.ТекущиеДанные;
		
		СтруктураДанных = Новый Структура;
		СтруктураДанных.Вставить("Номенклатура", Значение);
		// передаём цену
		СтруктураДанных.Вставить("Цена", ТекущиеДанные.Цена);
		
		// будет получено в СписокНоменклатурыОбработкаВыбора()
		ОповеститьОВыборе(СтруктураДанных);
	КонецПроцедуры
	```
